<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Central Integrado</title>
    
    <!-- Scripts e Estilos Comuns -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Estilos Globais */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* --- Estilos para App de Projetos --- */
        #projetos-app-container .content-section { display: none; }
        #projetos-app-container .content-section.active { display: block; }
        #projetos-app-container .chart-container { position: relative; width: 100%; height: 250px; }
        #projetos-app-container .large-chart-container { position: relative; width: 100%; height: 400px; }
        #projetos-app-container .checklist-item { display: flex; align-items: center; padding: 0.5rem; border-radius: 0.375rem; }
        #projetos-app-container .kanban-card { cursor: grab; }
        #projetos-app-container .kanban-column .kanban-card.dragging { opacity: 0.5; }
        #projetos-app-container .dark input, #projetos-app-container .dark select, #projetos-app-container .dark textarea { background-color: #334155; color: #f1f5f9; border-color: #475569; }
        #projetos-app-container .dark input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); }
        #projetos-app-container .product-tab { cursor: pointer; padding: 8px 16px; border-radius: 6px; transition: background-color 0.2s; }
        #projetos-app-container .product-tab:hover { background-color: #475569; }
        #projetos-app-container .product-tab.active { background-color: #0761FF; color: #ffffff; font-weight: 600; }
        #projetos-app-container .next-steps-tab { cursor: pointer; padding: 8px 16px; margin-bottom: -1px; border: 1px solid transparent; border-bottom: none; transition: background-color 0.2s, border-color 0.2s; }
        #projetos-app-container .next-steps-tab.active { border-color: #475569; background-color: #1e293b; border-radius: 6px 6px 0 0; color: #0761FF; font-weight: 600; }
        #projetos-app-container .loader { border: 4px solid #475569; border-left-color: #0761FF; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- Estilos para App de Status --- */
        #status-app-container .page { display: none; }
        #status-app-container .page.active { display: block; }
        #status-app-container .tab-content { display: none; }
        #status-app-container .tab-content.active { display: block; }
        .dark #status-app-container body { background-color: #1e293b; color: #e2e8f0; }
        .dark #status-app-container .sidebar { background-color: #0f172a; }
        .dark #status-app-container .main-content-bg { background-color: #1e293b; }
        .dark #status-app-container .card-bg { background-color: #0f172a99; }
        .dark #status-app-container .text-main { color: #f1f5f9; }
        .dark #status-app-container .text-secondary { color: #94a3b8; }
        .dark #status-app-container .border-color { border-color: #334155; }
        .dark #status-app-container .gantt-bar-bg { background-color: #334155; }
        .dark #status-app-container .city-card-projects { background-color: #1e293b !important; border-color: #334155 !important; }
        .dark #status-app-container .city-card-projects a { color: #e2e8f0 !important; }
        .dark #status-app-container .status-tooltip { background-color: #1e293b !important; border-color: #334155 !important; }
        .dark #status-app-container .status-tooltip-link { color: #e2e8f0 !important; }
        .dark #status-app-container .tab-link { color: #9ca3af; border-color: transparent; }
        .dark #status-app-container .tab-link:hover { color: #e5e7eb; border-color: #4b5563; }
        .dark #status-app-container .tab-link.active { color: #ffffff; border-color: #38bdf8; font-weight: 700; }
        .dark #status-app-container #status_drop-zone { background-color: #1e293b; border-color: #475569; }
        .dark #status-app-container #status_drop-zone.dragover { background-color: #334155; border-color: #60a5fa; }
        #status-app-container .sidebar-link.active { background-color: #0284c7; font-weight: 600; }
        #status-app-container .gantt-bar { height: 100%; border-radius: 0.25rem; }
        #status-app-container .timeline-marker { transition: transform 0.2s ease-in-out; }
        #status-app-container .timeline-marker:hover { transform: scale(1.6); z-index: 10; }
        #status-app-container .timeline-marker .tooltip { visibility: hidden; opacity: 0; transition: opacity 0.2s; }
        #status-app-container .timeline-marker:hover .tooltip { visibility: visible; opacity: 1; }
        #status-app-container .triangle { width: 0; height: 0; border-left: 8px solid transparent; border-right: 8px solid transparent; border-bottom: 14px solid; }
        #status-app-container .city-card-projects { opacity: 0; visibility: hidden; transform: translateY(0.5rem); transition: opacity 0.2s ease-out, transform 0.2s ease-out; pointer-events: none; }
        #status-app-container .city-card:hover .city-card-projects { opacity: 1; visibility: visible; transform: translateY(0); pointer-events: auto; }
    </style>
</head>
<body class="bg-slate-900 text-slate-200">

    <!-- Tela de Sele√ß√£o de Portf√≥lio -->
    <div id="portfolio-screen" class="flex flex-col items-center justify-center min-h-screen p-4 text-center">
        <img src="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3e%3crect width='100' height='100' rx='20' fill='%230761FF'/%3e%3ctext x='50' y='55' font-family='Inter, sans-serif' font-size='75' font-weight='bold' fill='white' text-anchor='middle' dominant-baseline='middle'%3eB%3c/text%3e%3c/svg%3e" alt="Betha Logo" class="w-24 h-24 mx-auto rounded-2xl mb-6">
        <h1 class="text-4xl font-bold text-white mb-4">Bem-vindo ao Dashboard Central</h1>
        <p class="text-slate-400 mb-12 max-w-xl">Selecione um portf√≥lio para carregar os dashboards correspondentes.</p>
        <div class="flex flex-col md:flex-row gap-6">
            <button class="portfolio-btn bg-slate-800 text-white font-semibold px-8 py-4 rounded-lg hover:bg-slate-700 transition-colors text-lg shadow-lg flex items-center justify-center">
                <span class="mr-3 text-2xl">üìÅ</span> Contas Premium SC/MG
            </button>
            <button class="portfolio-btn bg-slate-800 text-white font-semibold px-8 py-4 rounded-lg hover:bg-slate-700 transition-colors text-lg shadow-lg flex items-center justify-center">
                <span class="mr-3 text-2xl">üìÅ</span> Contas Premium SC/SP
            </button>
            <button class="portfolio-btn bg-slate-800 text-white font-semibold px-8 py-4 rounded-lg hover:bg-slate-700 transition-colors text-lg shadow-lg flex items-center justify-center">
                <span class="mr-3 text-2xl">üìÅ</span> M√©dias Contas
            </button>
        </div>
    </div>


    <!-- Tela de Menu Inicial -->
    <div id="menu-screen" class="hidden flex-col items-center justify-center min-h-screen p-4 text-center">
        <img src="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3e%3crect width='100' height='100' rx='20' fill='%230761FF'/%3e%3ctext x='50' y='55' font-family='Inter, sans-serif' font-size='75' font-weight='bold' fill='white' text-anchor='middle' dominant-baseline='middle'%3eB%3c/text%3e%3c/svg%3e" alt="Betha Logo" class="w-24 h-24 mx-auto rounded-2xl mb-6">
        <h1 class="text-4xl font-bold text-white mb-4">Dashboard Central</h1>
        <p class="text-slate-400 mb-12 max-w-3xl">Selecione o tipo de dashboard que voc√™ deseja carregar ou consulte um projeto espec√≠fico.</p>
        <div class="flex flex-col lg:flex-row items-start gap-8">
            <!-- Se√ß√£o de Dashboards -->
            <div class="bg-slate-800 p-8 rounded-lg shadow-lg flex flex-col gap-6 items-center">
                 <h2 class="text-2xl font-bold text-white -mt-2 mb-2">Carregar Dashboard</h2>
                <button id="projetos-btn" class="bg-[#0761FF] text-white font-semibold px-8 py-4 rounded-lg hover:bg-[#054ed9] transition-colors text-lg shadow-lg flex items-center justify-center w-full">
                    <span class="mr-3 text-2xl">üìä</span> Gerenciamento de Projetos
                </button>
                <button id="status-btn" class="bg-sky-500 text-white font-semibold px-8 py-4 rounded-lg hover:bg-sky-600 transition-colors text-lg shadow-lg flex items-center justify-center w-full">
                    <span class="mr-3 text-2xl">üöÄ</span> Report Executivo (Status)
                </button>
            </div>
            <!-- Se√ß√£o de Consulta -->
            <div class="bg-slate-800 p-8 rounded-lg shadow-lg flex flex-col gap-6 items-center w-full lg:w-auto">
                <h2 class="text-2xl font-bold text-white -mt-2 mb-2">Consultar Projeto</h2>
                <div class="w-full">
                    <label for="project-select" class="sr-only">Selecione um projeto</label>
                    <select id="project-select" class="bg-slate-700 text-white w-full px-4 py-4 rounded-lg text-lg border-2 border-slate-600 focus:border-sky-500 focus:ring-sky-500">
                        <option>Projeto Bahia - Salvador</option>
                        <option>Projeto RJ - Cabo Frio</option>
                        <option>Projeto SP - Campos do Jord√£o</option>
                    </select>
                </div>
                <button class="bg-emerald-500 text-white font-semibold px-8 py-4 rounded-lg hover:bg-emerald-600 transition-colors text-lg shadow-lg w-full">
                    Consultar
                </button>
            </div>
        </div>
         <button id="back-to-portfolios-btn" class="mt-12 text-slate-400 hover:text-white transition-colors flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
            Voltar para Portf√≥lios
        </button>
    </div>

    <!-- ########################################## -->
    <!-- ### CONTAINER PARA O APP DE PROJETOS ### -->
    <!-- ########################################## -->
    <div id="projetos-app-container" class="hidden">
        <!-- Importer Screen -->
        <div id="projetos_importer-screen" class="flex flex-col items-center justify-center min-h-screen p-4">
            <div class="text-center">
                <img src="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3e%3crect width='100' height='100' rx='20' fill='%230761FF'/%3e%3ctext x='50' y='55' font-family='Inter, sans-serif' font-size='75' font-weight='bold' fill='white' text-anchor='middle' dominant-baseline='middle'%3eB%3c/text%3e%3c/svg%3e" alt="Betha Logo" class="w-20 h-20 mx-auto rounded-2xl">
                <h1 class="text-3xl font-bold text-white mt-6">Dashboard de Gerenciamento de Projetos</h1>
                <p class="text-slate-400 mt-2">Importe sua planilha de projeto para come√ßar.</p>
            </div>

            <div id="projetos_drop-zone" class="mt-10 w-full max-w-lg p-10 border-2 border-dashed border-slate-600 rounded-lg text-center cursor-pointer hover:border-[#0761FF] hover:bg-slate-800 transition-colors">
                <svg class="mx-auto h-12 w-12 text-slate-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                </svg>
                <p class="mt-4 text-slate-300">Arraste e solte sua planilha aqui</p>
                <p class="text-xs text-slate-500 mt-1">ou</p>
                <button type="button" class="mt-2 text-sm font-semibold text-[#0761FF] hover:text-[#3a86ff]">Clique para selecionar o arquivo</button>
                <input type="file" id="projetos_file-input" class="hidden" accept=".xlsx, .xls">
            </div>

            <div id="projetos_loading-container" class="hidden mt-8 text-center">
                <div class="loader mx-auto"></div>
                <p id="projetos_import-status" class="mt-4 text-slate-400">Processando arquivo...</p>
            </div>

            <button class="back-to-menu-btn mt-8 flex items-center justify-center px-4 py-2 text-slate-400 hover:text-white rounded-lg transition-colors">
                <span class="mr-2 text-lg">‚Ü©Ô∏è</span> Voltar ao Menu
            </button>
        </div>

        <!-- Main Dashboard Container -->
        <div id="projetos_dashboard-container" class="flex min-h-screen hidden">
            <!-- Sidebar Navigation -->
            <aside class="w-64 bg-slate-900 shadow-lg flex-shrink-0 flex flex-col">
                <div class="p-6 flex items-center border-b border-slate-700">
                    <img src="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3e%3crect width='100' height='100' rx='20' fill='%230761FF'/%3e%3ctext x='50' y='55' font-family='Inter, sans-serif' font-size='75' font-weight='bold' fill='white' text-anchor='middle' dominant-baseline='middle'%3eB%3c/text%3e%3c/svg%3e" alt="Betha Logo" class="w-10 h-10 mr-3 rounded">
                    <div class="flex flex-col">
                        <span class="text-white font-bold text-lg">Betha Sistemas</span>
                        <span class="text-sm text-slate-400">Gerenciamento</span>
                    </div>
                </div>
                <nav id="projetos_main-nav" class="mt-6 flex-grow">
                    <a href="#overview" class="nav-link flex items-center px-6 py-3 text-white hover:bg-[#0761FF] bg-[#0761FF] font-semibold">
                        <span class="mr-3">üìä</span> Vis√£o Geral
                    </a>
                    <a href="#team" class="nav-link flex items-center px-6 py-3 text-white hover:bg-[#0761FF]">
                        <span class="mr-3">üë•</span> Equipe do Projeto
                    </a>
                    <a href="#client-data" class="nav-link flex items-center px-6 py-3 text-white hover:bg-[#0761FF]">
                        <span class="mr-3">üë§</span> Dados do Cliente
                    </a>
                    <a href="#produtos" class="nav-link flex items-center px-6 py-3 text-white hover:bg-[#0761FF]">
                        <span class="mr-3">üì¶</span> Produtos Contratados
                    </a>
                    <a href="#timeline" class="nav-link flex items-center px-6 py-3 text-white hover:bg-[#0761FF]">
                        <span class="mr-3">‚è≥</span> Cronograma
                    </a>
                    <a href="#kanban" class="nav-link flex items-center px-6 py-3 text-white hover:bg-[#0761FF]">
                        <span class="mr-3">üóÇÔ∏è</span> Kanban
                    </a>
                    <div id="projetos_verticals-nav-links"></div>
                    <a href="#risks" class="nav-link flex items-center px-6 py-3 text-white hover:bg-[#0761FF]">
                        <span class="mr-3">‚ö†Ô∏è</span> Gest√£o de Riscos
                    </a>
                    <a href="#lessons" class="nav-link flex items-center px-6 py-3 text-white hover:bg-[#0761FF]">
                        <span class="mr-3">üí°</span> Li√ß√µes Aprendidas
                    </a>
                    <a href="#next-steps" class="nav-link flex items-center px-6 py-3 text-white hover:bg-[#0761FF]">
                        <span class="mr-3">üöÄ</span> Pr√≥ximos Passos
                    </a>
                    <a href="#export" class="nav-link flex items-center px-6 py-3 text-white hover:bg-[#0761FF]">
                        <span class="mr-3">üìÑ</span> Extra√ß√£o
                    </a>
                </nav>
                <div class="p-4 border-t border-slate-700 mt-auto">
                    <button class="back-to-menu-btn w-full flex items-center justify-center px-4 py-2 text-white bg-slate-700 hover:bg-slate-600 rounded-lg">
                        <span class="mr-2 text-lg">‚Ü©Ô∏è</span> Voltar ao Menu
                    </button>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="flex-1 p-6 sm:p-8 md:p-10 bg-slate-900 overflow-y-auto">
                <section id="projetos_overview" class="content-section active">
                    <div class="flex justify-between items-center mb-6"><h2 id="projetos_project-title" class="text-3xl font-bold text-slate-50"></h2></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="bg-slate-800 p-6 rounded-lg shadow-sm"><h3 class="font-semibold text-slate-400">Gerente do Projeto</h3><p id="projetos_manager-name" class="text-2xl font-bold text-slate-200 mt-2"></p></div>
                        <div class="bg-slate-800 p-6 rounded-lg shadow-sm"><h3 class="font-semibold text-slate-400">Valor do Projeto</h3><p id="projetos_project-value" class="text-2xl font-bold text-slate-200 mt-2"></p></div>
                        <div class="bg-slate-800 p-6 rounded-lg shadow-sm"><h3 class="font-semibold text-slate-400">Prazo Final</h3><p id="projetos_project-deadline" class="text-3xl font-bold text-[#0761FF] mt-2"></p></div>
                        <div id="projetos_status-light-card" class="bg-slate-800 p-6 rounded-lg shadow-sm"><h3 class="font-semibold text-slate-400">Farol de Status</h3><div class="flex items-center mt-2"><span id="projetos_status-light-indicator" class="w-4 h-4 rounded-full mr-2"></span><p id="projetos_status-light-text" class="text-2xl font-bold text-slate-200"></p></div></div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                        <div class="bg-slate-800 p-6 rounded-lg shadow-sm"><h3 class="text-lg font-semibold text-center text-slate-50 mb-4">Status dos Marcos (por Peso)</h3><div class="chart-container"><canvas id="projetos_milestoneProgressChart"></canvas></div></div>
                        <div class="bg-slate-800 p-6 rounded-lg shadow-sm"><h3 class="text-lg font-semibold text-center text-slate-50 mb-4">Conclus√£o por Vertical (%)</h3><div class="chart-container"><canvas id="projetos_verticalsChart"></canvas></div></div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="bg-slate-800 p-6 rounded-lg shadow-sm"><h3 class="text-xl font-bold text-slate-50 mb-4">Marcos do Projeto (Conclu√≠do)</h3><div id="projetos_milestones-checklist" class="space-y-2"></div></div>
                        <div class="bg-slate-800 p-6 rounded-lg shadow-sm"><h3 class="text-xl font-bold text-slate-50 mb-4">Documentos Chave</h3><div id="projetos_documents-checklist" class="space-y-2"></div></div>
                    </div>
                </section>
                <section id="projetos_team" class="content-section"><h2 class="text-3xl font-bold text-slate-50 mb-6">Equipe do Projeto</h2><div id="projetos_team-container" class="bg-slate-800 p-6 rounded-lg shadow-sm"></div></section>
                <section id="projetos_client-data" class="content-section"><h2 class="text-3xl font-bold text-slate-50 mb-6">Dados do Cliente e Plano de Comunica√ß√£o</h2><div id="projetos_client-data-container" class="bg-slate-800 p-6 rounded-lg shadow-sm"></div></section>
                <section id="projetos_produtos" class="content-section"><h2 class="text-3xl font-bold text-slate-50 mb-6">Produtos Contratados</h2><p class="mb-8 text-slate-400 max-w-3xl">Rela√ß√£o de produtos e chamados de implanta√ß√£o por vertical.</p><div id="projetos_produtos-container" class="bg-slate-800 p-6 rounded-lg shadow-sm"></div></section>
                <section id="projetos_timeline" class="content-section"><h2 class="text-3xl font-bold text-slate-50 mb-6">Linha do Tempo do Projeto</h2><p class="mb-8 text-slate-400 max-w-3xl">Esta se√ß√£o oferece uma vis√£o detalhada do progresso de cada atividade do cronograma.</p><div class="bg-slate-800 p-6 rounded-lg shadow-sm mb-8"><h3 class="text-xl font-bold text-slate-50 mb-4">Progresso das Atividades</h3><div class="overflow-x-auto"><div id="projetos_timeline-container" class="min-w-[800px]"></div></div></div></section>
                <section id="projetos_kanban" class="content-section"><div class="flex justify-between items-center mb-6"><h2 class="text-3xl font-bold text-slate-50">Kanban por Verticais</h2></div><p class="mb-8 text-slate-400 max-w-3xl">Arraste e solte os cards para organizar o status de cada vertical. Esta vis√£o √© independente do cronograma principal.</p><div id="projetos_kanban-board" class="flex overflow-x-auto space-x-4 pb-4"></div></section>
                <div id="projetos_verticals-sections-container"></div>
                <section id="projetos_risks" class="content-section"><h2 class="text-3xl font-bold text-slate-50 mb-6">Gest√£o de Riscos</h2><p class="mb-8 text-slate-400 max-w-3xl">O gerenciamento proativo de riscos √© essencial. Aqui, visualizamos a distribui√ß√£o dos riscos por prioridade e origem. A tabela detalhada abaixo permite filtrar e analisar cada risco individualmente.</p><div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-10"><div class="bg-slate-800 p-6 rounded-lg shadow-sm"><h3 class="text-lg font-semibold text-center text-slate-50 mb-4">Riscos por Prioridade</h3><div class="chart-container"><canvas id="projetos_priorityChart"></canvas></div></div><div class="bg-slate-800 p-6 rounded-lg shadow-sm"><h3 class="text-lg font-semibold text-center text-slate-50 mb-4">Riscos por Origem</h3><div class="chart-container"><canvas id="projetos_originChart"></canvas></div></div></div><div class="bg-slate-800 p-6 rounded-lg shadow-sm"><div class="flex flex-wrap items-center justify-between mb-4 gap-4"><h3 class="text-xl font-bold text-slate-50">Lista de Riscos</h3><div class="flex items-center gap-4"><select id="projetos_priorityFilter" class="p-2 border rounded-md bg-slate-700 border-slate-600 shadow-sm"><option value="all">Toda Prioridade</option></select><select id="projetos_statusFilter" class="p-2 border rounded-md bg-slate-700 border-slate-600 shadow-sm"><option value="all">Todo Status</option></select></div><button id="projetos_generate-action-btn" class="bg-[#0761FF] text-white px-4 py-2 rounded-lg hover:bg-[#054ed9] transition-colors">‚ú® Gerar A√ß√£o para Risco</button></div><div class="overflow-x-auto"><table class="min-w-full divide-y divide-slate-700"><thead class="bg-slate-700"><tr><th class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">ID</th><th class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Resumo do Risco</th><th class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Prioridade</th><th class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Status</th></tr></thead><tbody id="projetos_risks-table-body" class="bg-slate-800 divide-y divide-slate-700"></tbody></table></div><div id="projetos_mitigation-action-box" class="mt-4 p-4 bg-slate-700 rounded-lg hidden"><h4 class="font-bold text-slate-200">Plano de A√ß√£o Sugerido:</h4><p id="projetos_mitigation-action-text" class="mt-2 text-slate-400"></p></div></div></section>
                <section id="projetos_lessons" class="content-section"><h2 class="text-3xl font-bold text-slate-50 mb-6">Li√ß√µes Aprendidas</h2><p class="mb-8 text-slate-400 max-w-3xl">Registre os aprendizados do projeto para consulta e melhoria cont√≠nua.</p><div class="bg-slate-800 p-6 rounded-lg shadow-sm mb-8"><h3 class="text-xl font-bold text-slate-50 mb-4">Adicionar Nova Li√ß√£o</h3><div class="space-y-4"><input type="text" id="projetos_lesson-input" placeholder="Descreva a li√ß√£o aprendida" class="p-2 border rounded-md w-full bg-transparent border-slate-600 focus:ring-[#0761FF] focus:border-[#0761FF]"><input type="text" id="projetos_lesson-context" placeholder="Contexto/Fase do projeto" class="p-2 border rounded-md w-full bg-transparent border-slate-600 focus:ring-[#0761FF] focus:border-[#0761FF]"><textarea id="projetos_lesson-resolution-input" placeholder="Descreva a resolu√ß√£o ou a√ß√£o tomada" class="p-2 border rounded-md w-full bg-transparent border-slate-600 focus:ring-[#0761FF] focus:border-[#0761FF]" rows="3"></textarea><select id="projetos_lesson-category" class="p-2 border rounded-md w-full bg-slate-700 border-slate-600"><option value="Positivo">Positivo</option><option value="Negativo">Negativo</option><option value="Melhoria">Ponto de Melhoria</option></select></div><button id="projetos_add-lesson-btn" class="mt-4 bg-[#0761FF] text-white px-4 py-2 rounded-lg hover:bg-[#054ed9] transition-colors">Adicionar Li√ß√£o</button></div><div class="bg-slate-800 p-6 rounded-lg shadow-sm"><h3 class="text-xl font-bold text-slate-50 mb-4">Lista de Li√ß√µes</h3><div class="overflow-x-auto"><table class="min-w-full divide-y divide-slate-700"><thead class="bg-slate-700"><tr><th class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider w-1/3">Li√ß√£o</th><th class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider w-1/3">Resolu√ß√£o</th><th class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Contexto/Fase</th><th class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Categoria</th><th class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">A√ß√µes</th></tr></thead><tbody id="projetos_lessons-table-body" class="bg-slate-800 divide-y divide-slate-700"></tbody></table></div></div></section>
                <section id="projetos_next-steps" class="content-section"><h2 class="text-3xl font-bold text-slate-50 mb-6">Pr√≥ximos Passos</h2><p class="mb-8 text-slate-400 max-w-3xl">Defina e acompanhe as pr√≥ximas a√ß√µes para garantir o progresso cont√≠nuo do projeto.</p><div class="bg-slate-800 p-6 rounded-lg shadow-sm mb-8"><h3 class="text-xl font-bold text-slate-50 mb-4">Adicionar Pr√≥ximo Passo</h3><div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end"><div class="md:col-span-3"><label for="projetos_next-step-input" class="block text-sm font-medium text-slate-300">Descri√ß√£o</label><input type="text" id="projetos_next-step-input" placeholder="Descreva a a√ß√£o" class="mt-1 p-2 border rounded-md w-full bg-transparent border-slate-600 focus:ring-[#0761FF] focus:border-[#0761FF]"></div><div><label for="projetos_next-step-responsible" class="block text-sm font-medium text-slate-300">Respons√°vel</label><input type="text" id="projetos_next-step-responsible" placeholder="Nome do respons√°vel" class="mt-1 p-2 border rounded-md w-full bg-transparent border-slate-600 focus:ring-[#0761FF] focus:border-[#0761FF]"></div><div><label for="projetos_next-step-date" class="block text-sm font-medium text-slate-300">Data</label><input type="date" id="projetos_next-step-date" class="mt-1 p-2 border rounded-md w-full bg-transparent border-slate-600 focus:ring-[#0761FF] focus:border-[#0761FF] dark:[color-scheme:dark]"></div><button id="projetos_add-next-step-btn" class="bg-[#0761FF] text-white px-4 py-2 rounded-lg hover:bg-[#054ed9] transition-colors h-10">Adicionar Passo</button></div></div><div id="projetos_next-steps-container" class="bg-slate-800 p-6 rounded-lg shadow-sm"></div></section>
                <section id="projetos_export" class="content-section"><h2 class="text-3xl font-bold text-slate-50 mb-6">Extra√ß√£o de Dados</h2><p class="mb-8 text-slate-400 max-w-3xl">Exporte os dados das se√ß√µes "Li√ß√µes Aprendidas" e "Pr√≥ximos Passos" para um arquivo CSV.</p><div class="bg-slate-800 p-6 rounded-lg shadow-sm"><div class="flex flex-col md:flex-row gap-4"><button id="projetos_export-lessons-btn" class="bg-emerald-500 text-white px-6 py-3 rounded-lg hover:bg-emerald-600 transition-colors w-full md:w-auto disabled:opacity-50 disabled:cursor-not-allowed">Exportar Li√ß√µes Aprendidas (CSV)</button><button id="projetos_export-next-steps-btn" class="bg-emerald-500 text-white px-6 py-3 rounded-lg hover:bg-emerald-600 transition-colors w-full md:w-auto disabled:opacity-50 disabled:cursor-not-allowed">Exportar Pr√≥ximos Passos (CSV)</button></div></div></section>
            </main>
        </div>
    </div>
    
    <!-- ######################################## -->
    <!-- ### CONTAINER PARA O APP DE STATUS ### -->
    <!-- ######################################## -->
    <div id="status-app-container" class="hidden">
        <!-- Tela de Importa√ß√£o -->
        <div id="status_import-screen" class="min-h-screen flex flex-col items-center justify-center main-content-bg p-4">
            <div class="w-full max-w-2xl text-center">
                <div class="flex justify-center mb-6">
                    <div class="w-16 h-16 flex-shrink-0">
                        <svg viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg" class="w-full h-full"><rect width="40" height="40" rx="8" fill="#4A65E0"/><text x="50%" y="50%" font-family="Inter, sans-serif" font-size="28" font-weight="bold" font-style="italic" fill="white" text-anchor="middle" dy=".35em">B</text></svg>
                    </div>
                </div>
                <h1 class="text-4xl font-bold text-main mb-2">Report Executivo de Projetos</h1>
                <p class="text-lg text-secondary mb-8">Importe a planilha de projetos para gerar o dashboard atualizado.</p>
                <div id="status_drop-zone" class="border-2 border-dashed rounded-lg p-10 text-center cursor-pointer transition-colors duration-300">
                    <input type="file" id="status_file-input" class="hidden" accept=".xlsx, .xls">
                    <svg class="mx-auto h-12 w-12 text-secondary" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>
                    <p class="mt-4 text-sm text-secondary"><span class="font-semibold text-sky-500">Clique para carregar</span> ou arraste e solte a planilha aqui.</p>
                    <p class="text-xs text-secondary mt-1">XLSX ou XLS</p>
                </div>
                <div id="status_loading-spinner" class="hidden mt-6">
                    <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-sky-500 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    <span class="text-lg text-secondary align-middle">Processando dados...</span>
                </div>
                <p id="status_error-message" class="text-red-500 mt-4 font-semibold hidden"></p>
                <button class="back-to-menu-btn mt-8 flex items-center justify-center px-4 py-2 text-slate-400 hover:text-white rounded-lg transition-colors mx-auto">
                    <span class="mr-2 text-lg">‚Ü©Ô∏è</span> Voltar ao Menu
                </button>
            </div>
        </div>

        <!-- Container do Dashboard -->
        <div id="status_dashboard-container" class="hidden">
            <div class="relative min-h-screen lg:flex">
                <div id="status_sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 lg:hidden hidden"></div>
                <aside id="status_sidebar" class="w-72 sidebar shadow-lg text-white fixed inset-y-0 left-0 z-40 transform -translate-x-full transition-transform duration-300 ease-in-out lg:relative lg:translate-x-0 flex flex-col">
                    <div class="p-6 flex items-center border-b border-slate-700">
                        <div class="w-10 h-10 mr-3 flex-shrink-0"><svg viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg" class="w-full h-full"><rect width="40" height="40" rx="8" fill="#4A65E0"/><text x="50%" y="50%" font-family="Inter, sans-serif" font-size="28" font-weight="bold" font-style="italic" fill="white" text-anchor="middle" dy=".35em">B</text></svg></div>
                        <div><span class="font-bold text-xl">Betha Sistemas</span><span class="block text-sm text-slate-400">Portf√≥lio de Projetos</span></div>
                    </div>
                    <nav id="status_main-nav" class="mt-4 flex-grow"></nav>
                    <div class="p-4 border-t border-slate-700 mt-auto">
                        <button class="back-to-menu-btn w-full flex items-center justify-center px-4 py-2 text-white bg-slate-700 hover:bg-slate-600 rounded-lg">
                            <span class="mr-2 text-lg">‚Ü©Ô∏è</span> Voltar ao Menu
                        </button>
                    </div>
                </aside>
                <main class="flex-1 p-4 sm:p-6 main-content-bg">
                    <div class="flex justify-between items-center mb-4">
                        <button id="status_hamburger-btn" class="p-2 rounded-md text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 focus:outline-none lg:hidden"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg></button>
                        <div id="status_theme-toggle-container" class="flex justify-end w-full" style="display: none;"><button id="status_theme-toggle" class="p-2 rounded-full bg-white dark:bg-slate-800 text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 dark:focus:ring-offset-slate-900"><svg id="status_theme-icon-light" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg><svg id="status_theme-icon-dark" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg></button></div>
                    </div>
                    <div id="status_page-container"></div>
                </main>
            </div>
        </div>
    </div>


<script>
// =================================================================
// =================== L√ìGICA DE CONTROLE PRINCIPAL =================
// =================================================================
document.addEventListener('DOMContentLoaded', () => {
    const portfolioScreen = document.getElementById('portfolio-screen');
    const menuScreen = document.getElementById('menu-screen');
    const projetosAppContainer = document.getElementById('projetos-app-container');
    const statusAppContainer = document.getElementById('status-app-container');

    const portfolioBtns = document.querySelectorAll('.portfolio-btn');
    const projetosBtn = document.getElementById('projetos-btn');
    const statusBtn = document.getElementById('status-btn');
    const backBtns = document.querySelectorAll('.back-to-menu-btn');
    const backToPortfoliosBtn = document.getElementById('back-to-portfolios-btn');


    let isProjetosInitialized = false;
    let isStatusInitialized = false;

    function showScreen(screen) {
        portfolioScreen.style.display = 'none';
        menuScreen.style.display = 'none';
        projetosAppContainer.classList.add('hidden');
        statusAppContainer.classList.add('hidden');
        
        if (screen === portfolioScreen || screen === menuScreen) {
            screen.style.display = 'flex';
        } else {
            screen.classList.remove('hidden');
        }
    }

    portfolioBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            showScreen(menuScreen);
        });
    });

    projetosBtn.addEventListener('click', () => {
        showScreen(projetosAppContainer);
        if (!isProjetosInitialized) {
            ProjetosApp.init();
            isProjetosInitialized = true;
        }
    });

    statusBtn.addEventListener('click', () => {
        showScreen(statusAppContainer);
        if (!isStatusInitialized) {
            StatusApp.init();
            isStatusInitialized = true;
        }
    });

    backBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            // Check which app is active and reset it
            if (btn.closest('#projetos-app-container')) {
                ProjetosApp.reset();
            } else if (btn.closest('#status-app-container')) {
                StatusApp.reset();
            }
            showScreen(menuScreen);
        });
    });

    backToPortfoliosBtn.addEventListener('click', () => {
        showScreen(portfolioScreen);
    });

    showScreen(portfolioScreen);
});


// =================================================================
// ======================= APP DE PROJETOS =========================
// =================================================================
const ProjetosApp = {
    priorityChartInstance: null,
    originChartInstance: null,
    milestoneProgressChartInstance: null,
    verticalsChartInstance: null,
    allVerticals: [],
    projectData: {},
    teamData: [],
    clientData: [],
    produtosContratados: [],
    timelineData: [],
    verticalTimelines: {}, // Para armazenar cronogramas de verticais
    documentsData: [],
    produtosPorVertical: {},
    allRisks: [],
    lessonsLearnedData: [],
    nextStepsData: [],
    verticalsKanbanStatus: {},
    customTasks: {},
    productNotes: {},
    isFetching: false,

    init: function() {
        this.lessonsLearnedData = JSON.parse(localStorage.getItem('projetos_lessonsLearnedData')) || [];
        this.nextStepsData = JSON.parse(localStorage.getItem('projetos_nextStepsData')) || [];
        this.verticalsKanbanStatus = JSON.parse(localStorage.getItem('projetos_verticalsKanbanStatus')) || [];
        this.customTasks = JSON.parse(localStorage.getItem('projetos_customTasks')) || [];
        this.productNotes = JSON.parse(localStorage.getItem('projetos_productNotes')) || [];
        this.setupImporter();
    },
    
    reset: function() {
        document.getElementById('projetos_dashboard-container').classList.add('hidden');
        document.getElementById('projetos_importer-screen').classList.remove('hidden');
        document.getElementById('projetos_drop-zone').classList.remove('hidden');
        document.getElementById('projetos_loading-container').classList.add('hidden');
        const fileInput = document.getElementById('projetos_file-input');
        if (fileInput) fileInput.value = '';
    },

    setupImporter: function() {
        const dropZone = document.getElementById('projetos_drop-zone');
        const fileInput = document.getElementById('projetos_file-input');
        const loadingContainer = document.getElementById('projetos_loading-container');
        const importStatus = document.getElementById('projetos_import-status');

        const triggerFileInput = () => fileInput.click();
        
        dropZone.addEventListener('click', triggerFileInput);
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.add('border-[#0761FF]', 'bg-slate-800');
        });
        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.remove('border-[#0761FF]', 'bg-slate-800');
        });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.remove('border-[#0761FF]', 'bg-slate-800');
            const files = e.dataTransfer.files;
            if (files.length) {
                this.handleFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) {
                this.handleFile(e.target.files[0]);
            }
        });
    },

    handleFile: function(file) {
        const loadingContainer = document.getElementById('projetos_loading-container');
        const dropZone = document.getElementById('projetos_drop-zone');
        const importStatus = document.getElementById('projetos_import-status');

        loadingContainer.classList.remove('hidden');
        dropZone.classList.add('hidden');
        importStatus.textContent = `Processando '${file.name}'...`;
        importStatus.classList.remove('text-red-500');

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                
                // Resetar dados antes de processar
                this.timelineData = [];
                this.verticalTimelines = {};
                this.teamData = [];
                this.clientData = [];
                this.produtosContratados = [];
                this.documentsData = [];
                this.allRisks = [];

                this.processAllSheets(workbook);
                
                this.produtosPorVertical = this.getFixedChecklistData();
                this.setupVerticals();
                
                setTimeout(() => {
                    this.launchDashboard();
                }, 1000);

            } catch (error) {
                console.error("Erro ao processar a planilha (Projetos):", error);
                importStatus.textContent = "Erro ao ler o arquivo. Verifique o formato e se todas as abas necess√°rias existem.";
                importStatus.classList.add('text-red-500');
                loadingContainer.classList.add('hidden');
                dropZone.classList.remove('hidden');
            }
        };
        reader.readAsArrayBuffer(file);
    },

    processAllSheets: function(workbook) {
        workbook.SheetNames.forEach(sheetName => {
            const sheet = workbook.Sheets[sheetName];
            const lowerSheetName = sheetName.toLowerCase().trim();

            if (lowerSheetName === 'dados gerais') this.processProjectSheet(sheet);
            else if (lowerSheetName === 'equipe do projeto') this.processTeamSheet(sheet);
            else if (lowerSheetName === 'dados cliente') this.processClientSheet(sheet);
            else if (lowerSheetName === 'produto contratado') this.processProdutosSheet(sheet);
            else if (lowerSheetName === 'documentos chaves') this.processDocumentsSheet(sheet);
            else if (lowerSheetName === 'riscos') this.processRisksSheet(sheet);
            else if (lowerSheetName === 'cronograma macro') {
                this.timelineData = this.parseTimelineData(sheet);
            } else if (lowerSheetName.startsWith('cronograma - ')) {
                const verticalName = sheetName.substring('cronograma - '.length).trim();
                if (verticalName) {
                    this.verticalTimelines[verticalName] = this.parseTimelineData(sheet);
                }
            }
        });
    },
    
    parseTimelineData: function(sheet) {
        const data = XLSX.utils.sheet_to_json(sheet);
        if (data.length === 0) return [];
        const headers = Object.keys(data[0]);
        const etapaCol = this.findColumn(headers, ['Etapa', 'Atividade']);
        const startCol = this.findColumn(headers, ['Data Inicio', 'Data de In√≠cio']);
        const endCol = this.findColumn(headers, ['Data Fim', 'Data de Fim']);
        const statusCol = this.findColumn(headers, ['Situa√ß√£o', 'Status']);
        return data.map((row, index) => ({
            id: row['ID'] || (index + 1),
            title: row[etapaCol],
            startDate: this.excelDateToJSDate(row[startCol]),
            endDate: this.excelDateToJSDate(row[endCol]),
            status: row[statusCol]
        }));
    },

    findColumn: function(headers, possibleNames) {
        for (const name of possibleNames) {
            const header = headers.find(h => h.toLowerCase().trim() === name.toLowerCase().trim());
            if (header) return header;
        }
        return null;
    },

    excelDateToJSDate: function(excelDate) {
        if (typeof excelDate !== 'number') {
            if(typeof excelDate === 'string' && excelDate.match(/^\d{4}-\d{2}-\d{2}$/)) {
                return excelDate;
            }
            return null;
        };
        const date = new Date((excelDate - 25569) * 86400 * 1000);
        const tzOffset = date.getTimezoneOffset() * 60000;
        return new Date(date.getTime() + tzOffset).toISOString().split('T')[0];
    },

    processProjectSheet: function(sheet) {
        const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
        const data = {};
        rows.forEach(row => {
            if (row.length >= 2 && row[0] && row[1]) {
                const key = row[0].toString().trim().toLowerCase();
                const value = row[1].toString().trim();
                data[key] = value;
            }
        });
        const projectValueRaw = data['valor do projeto'] || data['valor do projeto'] || 0;
        this.projectData = {
            projectName: data['nome do projeto'],
            projectManager: data['gerente do projeto'],
            projectValue: parseFloat(projectValueRaw).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }),
        };
    },
    
    processTeamSheet: function(sheet) {
        const data = XLSX.utils.sheet_to_json(sheet);
        if (data.length === 0) { this.teamData = []; return; }
        const headers = Object.keys(data[0]);
        const nameCol = this.findColumn(headers, ['Nome']);
        const verticalCol = this.findColumn(headers, ['Vertical', 'Vertial']);
        const respCol = this.findColumn(headers, ['Responsabilidade']);
        this.teamData = data.map(row => {
            let vertical = row[verticalCol] || '';
            if (vertical.toLowerCase().startsWith('cont') || vertical.toLowerCase().startsWith('cnt')) {
                 if (vertical.toLowerCase().includes('contrat')) { vertical = 'Contratos'; } else { vertical = 'Cont√°bil'; }
            }
            return { nome: row[nameCol], vertical: vertical, responsabilidade: row[respCol] }
        });
    },
    
    processClientSheet: function(sheet) {
        const data = XLSX.utils.sheet_to_json(sheet);
        if (data.length === 0) { this.clientData = []; return; }
        const headers = Object.keys(data[0]);
        const atuacaoCol = this.findColumn(headers, ['Atua√ß√£o']);
        const nomeCol = this.findColumn(headers, ['Nome']);
        const emailCol = this.findColumn(headers, ['Email']);
        const telCol = this.findColumn(headers, ['Telefone']);
        const comCol = this.findColumn(headers, ['Comunica√ß√£o']);
        const rotinaCol = this.findColumn(headers, ['Rotina']);
        this.clientData = data.map(row => ({
            'Atua√ß√£o': row[atuacaoCol], 'Nome': row[nomeCol], 'Email': row[emailCol] || 'nao.informado@cliente.com',
            'Telefone': row[telCol], 'NivelDeComunicacao': row[comCol], 'Rotina': row[rotinaCol] || 'Semanal'
        }));
    },
    
    processProdutosSheet: function(sheet) {
        const data = XLSX.utils.sheet_to_json(sheet);
        if (data.length === 0) { this.produtosContratados = []; return; }
        const headers = Object.keys(data[0]);
        const verticalCol = this.findColumn(headers, ['Vertical']);
        const produtoCol = this.findColumn(headers, ['Produto']);
        const entidadeCol = this.findColumn(headers, ['Entidade']);
        const chamadoCol = this.findColumn(headers, ['Chamado', 'Chamado de Implanta√ß√£o']);
        const senhaCol = this.findColumn(headers, ['Senhas de Produ√ß√£o', 'Senha Produ√ß√£o']);
        this.produtosContratados = data.map(row => ({
            vertical: row[verticalCol], produto: row[produtoCol], entidade: row[entidadeCol],
            chamado: row[chamadoCol], senhaProducao: row[senhaCol]
        }));
    },
    
    processDocumentsSheet: function(sheet) {
        const data = XLSX.utils.sheet_to_json(sheet);
        if (data.length === 0) { this.documentsData = []; return; }
        const headers = Object.keys(data[0]);
        const docCol = this.findColumn(headers, ['Documento', 'Nome']);
        const statusCol = this.findColumn(headers, ['Situa√ß√£o', 'Status']);
        const linkCol = this.findColumn(headers, ['Link']);
        this.documentsData = data.map(row => ({ name: row[docCol], status: row[statusCol], link: row[linkCol] }));
    },
    
    processRisksSheet: function(sheet) {
        if (!sheet) { this.allRisks = []; return; }
        const data = XLSX.utils.sheet_to_json(sheet);
        if (data.length === 0) { this.allRisks = []; return; }
        const headers = Object.keys(data[0]);
        const resumoCol = this.findColumn(headers, ['Resumo do Risco', 'Risco']);
        const prioCol = this.findColumn(headers, ['Prioridade']);
        const origemCol = this.findColumn(headers, ['Origem do risco']);
        const statusCol = this.findColumn(headers, ['Status']);
        this.allRisks = data.map((row, index) => ({
            id: row['ID'] || row['Seq'] || (index + 1), resumo: row[resumoCol], prioridade: row[prioCol] || 'Moderada',
            origem: row[origemCol] || 'N√£o especificada', status: row[statusCol] || 'Em Aberto'
        }));
    },
    
    setupVerticals: function() {
        this.allVerticals = [];
        const verticalDefinitions = {
            'arrecadacao': { key: 'arrecadacao', name: 'Arrecada√ß√£o', color: 'bg-sky-500', icon: 'üí∞' },
            'pessoal': { key: 'pessoal', name: 'Pessoal', color: 'bg-emerald-500', icon: 'üë•' },
            'compras': { key: 'compras', name: 'Compras/Contratos', color: 'bg-amber-500', icon: 'üõí' },
            'contabil': { key: 'contabil', name: 'Cont√°bil', color: 'bg-purple-500', icon: 'üßæ' }
        };
        for (const verticalKey in this.produtosPorVertical) {
            if (verticalDefinitions[verticalKey]) {
                this.allVerticals.push(verticalDefinitions[verticalKey]);
            }
        }
    },

    launchDashboard: function() {
        document.getElementById('projetos_importer-screen').classList.add('hidden');
        document.getElementById('projetos_dashboard-container').classList.remove('hidden');
        this.initializeApp();
    },
    
    initializeApp: function() {
        this.fullRender();
        this.setChartTheme();
        this.setupLessonsLearned();
        this.setupNextSteps();
        this.setupExportButtons();
        this.setupRiskListeners();
        this.setupKanbanListeners();
        this.initCharts();
    },

    fullRender: function() {
        this.populateGeneralInfo();
        this.renderTeam();
        this.renderClientData();
        this.renderProdutosContratados();
        this.renderChecklists();
        
        const verticalsNavContainer = document.getElementById('projetos_verticals-nav-links');
        const verticalsSectionsContainer = document.getElementById('projetos_verticals-sections-container');
        const mainTimelineLink = document.querySelector('#projetos_main-nav a[href="#timeline"]');
        const mainContent = document.querySelector('#projetos-app-container main');

        verticalsNavContainer.innerHTML = '';
        verticalsSectionsContainer.innerHTML = '';
        
        // Renderiza cronograma macro
        this.renderTimeline(document.getElementById('projetos_timeline-container'), this.timelineData);

        this.allVerticals.forEach(v => {
            const link = document.createElement('a');
            link.href = `#vertical-${v.key}`;
            link.className = 'nav-link flex items-center px-6 py-3 text-white hover:bg-[#0761FF]';
            link.innerHTML = `<span class="mr-3">${v.icon}</span> Vertical ${v.name}`;
            verticalsNavContainer.appendChild(link);

            const section = document.createElement('section');
            section.id = `projetos_vertical-${v.key}`;
            section.className = 'content-section';
            section.innerHTML = `
                <h2 class="text-3xl font-bold text-slate-50 mb-6">Checklist - Vertical ${v.name}</h2>
                <p class="mb-8 text-slate-400 max-w-3xl">Acompanhamento das tarefas espec√≠ficas da vertical de ${v.name}.</p>
                <div id="projetos_${v.key}-checklist-container" class="bg-slate-800 p-6 rounded-lg shadow-sm"></div>
            `;
            verticalsSectionsContainer.appendChild(section);
            this.renderVerticalProductPages(`projetos_${v.key}-checklist-container`, this.produtosPorVertical[v.key], v.key);
        });

        // Renderiza cronogramas de verticais
        Object.entries(this.verticalTimelines).forEach(([verticalName, timeline]) => {
            const verticalKey = verticalName.toLowerCase().replace(/[^a-z0-9]/g, '');
            const sectionId = `timeline-${verticalKey}`;
            const navLinkHref = `#${sectionId}`;

            const navLink = document.createElement('a');
            navLink.href = navLinkHref;
            navLink.className = 'nav-link flex items-center px-6 py-3 text-white hover:bg-[#0761FF]';
            navLink.innerHTML = `<span class="mr-3">üìÖ</span> Cronograma ${verticalName}`;
            mainTimelineLink.insertAdjacentElement('afterend', navLink);

            const section = document.createElement('section');
            section.id = `projetos_${sectionId}`;
            section.className = 'content-section';
            section.innerHTML = `
                <h2 class="text-3xl font-bold text-slate-50 mb-6">Cronograma - ${verticalName}</h2>
                <p class="mb-8 text-slate-400 max-w-3xl">Vis√£o detalhada do progresso das atividades para a vertical ${verticalName}.</p>
                <div class="bg-slate-800 p-6 rounded-lg shadow-sm mb-8">
                    <h3 class="text-xl font-bold text-slate-50 mb-4">Progresso das Atividades</h3>
                    <div class="overflow-x-auto">
                        <div id="projetos_timeline-container-${verticalKey}" class="min-w-[800px]"></div>
                    </div>
                </div>`;
            mainContent.appendChild(section);
            this.renderTimeline(section.querySelector(`#projetos_timeline-container-${verticalKey}`), timeline);
        });

        this.setupNavigation();
        this.renderRisksTable(this.allRisks);
        this.setupRiskFilters();
        this.renderLessonsLearned(); 
        this.renderNextSteps(); 
        this.renderKanbanBoard();
    },

    setChartTheme: function() {
        const gridColor = 'rgba(255, 255, 255, 0.1)', tickColor = '#94a3b8', legendColor = '#f8fafc';
        Chart.defaults.color = legendColor;
        Chart.defaults.borderColor = gridColor;
        Chart.defaults.scale.ticks.color = tickColor;
    },

    populateGeneralInfo: function() {
        document.getElementById('projetos_project-title').textContent = this.projectData.projectName || "Nome do Projeto";
        document.getElementById('projetos_manager-name').textContent = this.projectData.projectManager || "N/A";
        document.getElementById('projetos_project-value').textContent = this.projectData.projectValue || "N/A";
        const lastTask = this.timelineData[this.timelineData.length - 1];
        document.getElementById('projetos_project-deadline').textContent = (lastTask && lastTask.endDate) ? luxon.DateTime.fromISO(lastTask.endDate).toFormat('dd/MM/yyyy') : "N/A";
    },

    renderTeam: function() {
        const container = document.getElementById('projetos_team-container');
        if (!container) return;
        container.innerHTML = `<div class="overflow-x-auto"><table class="min-w-full divide-y divide-slate-700"><thead class="bg-slate-700"><tr><th class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Nome</th><th class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Vertical</th><th class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Responsabilidade</th></tr></thead><tbody class="bg-slate-800 divide-y divide-slate-700">${this.teamData.map(member => `<tr><td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-50">${member.nome || ''}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-slate-400">${member.vertical || ''}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-slate-400">${member.responsabilidade || ''}</td></tr>`).join('')}</tbody></table></div>`;
    },

    renderClientData: function() {
        const container = document.getElementById('projetos_client-data-container');
        if (!container) return;
        container.innerHTML = `<h3 class="text-xl font-bold text-slate-50 mb-4">Contatos e Comunica√ß√£o</h3><div class="overflow-x-auto"><table class="min-w-full divide-y divide-slate-700"><thead class="bg-slate-700"><tr><th class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Atua√ß√£o</th><th class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Nome</th><th class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Email</th><th class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Telefone</th><th class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">N√≠vel de Comunica√ß√£o</th><th class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Rotina de Comunica√ß√£o</th></tr></thead><tbody class="bg-slate-800 divide-y divide-slate-700">${this.clientData.map(contact => `<tr><td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-50">${contact['Atua√ß√£o'] || ''}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-slate-400">${contact['Nome'] || ''}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-slate-400">${contact['Email'] || ''}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-slate-400">${contact['Telefone'] || ''}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-slate-400">${contact['NivelDeComunicacao'] || ''}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-slate-400"><select class="p-1 border rounded-md text-sm bg-slate-700 border-slate-600"><option value="Diaria" ${contact['Rotina'] === 'Diaria' ? 'selected' : ''}>Di√°ria</option><option value="Semanal" ${contact['Rotina'] === 'Semanal' ? 'selected' : ''}>Semanal</option><option value="Quinzenal" ${contact['Rotina'] === 'Quinzenal' ? 'selected' : ''}>Quinzenal</option><option value="Mensal" ${contact['Rotina'] === 'Mensal' ? 'selected' : ''}>Mensal</option></select></td></tr>`).join('')}</tbody></table></div>`;
    },

    renderProdutosContratados: function() {
        const container = document.getElementById('projetos_produtos-container');
        if (!container) return;
        container.innerHTML = `<div class="overflow-x-auto"><table class="min-w-full divide-y divide-slate-700"><thead class="bg-slate-700"><tr><th class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Vertical</th><th class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Produto</th><th class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Entidade</th><th class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Chamado de Implanta√ß√£o</th><th class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Senhas de Produ√ß√£o</th></tr></thead><tbody class="bg-slate-800 divide-y divide-slate-700">${this.produtosContratados.map(produto => `<tr><td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-50">${produto.vertical || ''}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-slate-400">${produto.produto || ''}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-slate-400">${produto.entidade || ''}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-slate-400">${produto.chamado || ''}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-slate-400">${produto.senhaProducao || ''}</td></tr>`).join('')}</tbody></table></div>`;
    },

    renderTimeline: function(container, timelineDataArray) {
        if (!container) return;
        container.innerHTML = '';
        if (!timelineDataArray || timelineDataArray.length === 0) {
            container.innerHTML = '<p class="text-slate-400">Nenhum dado de cronograma para exibir.</p>';
            return;
        }
        container.classList.add('flex', 'flex-col', 'gap-2');
        container.innerHTML += `<div class="flex items-center text-sm font-bold text-slate-300 bg-slate-700 p-2 rounded-t-lg"><div class="w-1/3">Atividade</div><div class="w-2/3">Progresso</div></div>`;
        timelineDataArray.forEach(item => {
            const start = item.startDate ? luxon.DateTime.fromISO(item.startDate) : null;
            const end = item.endDate ? luxon.DateTime.fromISO(item.endDate) : null;
            const now = luxon.DateTime.now();
            let progress = 0, barColor = 'bg-[#0761FF]';
            if (item.status && item.status.toLowerCase() === 'concluido') { progress = 100; }
            else if (start && end && now > start) {
                const totalDuration = end.diff(start, 'days').days;
                const elapsedDuration = now.diff(start, 'days').days;
                if (totalDuration > 0) { progress = Math.max(0, Math.min(100, (elapsedDuration / totalDuration) * 100)); }
            }
            const daysRemaining = end ? end.diff(now, 'days').days : Infinity;
            if (progress === 100) { barColor = 'bg-emerald-500'; } 
            else if (now > end) { barColor = 'bg-red-500'; } 
            else if (daysRemaining <= 7) { barColor = 'bg-yellow-500'; }
            container.innerHTML += `<div class="flex items-center h-12 border-b border-slate-700"><div class="w-1/3 pr-4 text-sm"><div class="font-medium text-slate-300">${item.title}</div><div class="text-xs text-slate-400">${start ? start.toFormat('dd/MM/yy') : '?'} - ${end ? end.toFormat('dd/MM/yy') : '?'}</div></div><div class="w-2/3 flex items-center"><div class="w-full bg-slate-700 rounded-full h-4"><div class="${barColor} h-4 rounded-full text-xs text-white text-center flex items-center justify-center" style="width: ${progress}%">${progress.toFixed(0)}%</div></div></div></div>`;
        });
    },

    setupNavigation: function() {
        const allNavLinks = document.querySelectorAll('#projetos-app-container .nav-link');
        const allContentSections = document.querySelectorAll('#projetos-app-container .content-section');
        const updateActiveState = (targetId) => {
            allContentSections.forEach(section => {
                const sectionTarget = section.id.replace('projetos_', '');
                section.classList.toggle('active', sectionTarget === targetId);
            });
            allNavLinks.forEach(link => {
                const linkTarget = link.getAttribute('href').substring(1);
                link.classList.toggle('bg-[#0761FF]', linkTarget === targetId);
                link.classList.toggle('font-semibold', linkTarget === targetId);
            });
        };
        allNavLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetId = link.getAttribute('href').substring(1);
                history.pushState(null, null, `#${targetId}`);
                updateActiveState(targetId);
            });
        });
        updateActiveState('overview');
    },

    getTaskWeight: function(title) {
        const weights = {
            'planejamento e monitoramento': 2, 'kick-off': 1, 'diagn√≥stico t√©cnico': 2,
            'migra√ß√£o de hml': 4, 'configura√ß√£o de hml': 2, 'homologa√ß√£o de hml': 3,
            'migra√ß√£o de produ√ß√£o': 5, 'treinamento': 3, 'configura√ß√£o em produ√ß√£o': 2,
            'estabiliza√ß√£o': 3, 'opera√ß√£o assistida': 2
        };
        if (!title) return 1;
        const lowerCaseTitle = title.toLowerCase().trim();
        for (const key in weights) {
            if (lowerCaseTitle.includes(key)) {
                return weights[key];
            }
        }
        return 1; // Peso padr√£o
    },
    
    updateMilestoneChart: function() {
        if (!this.milestoneProgressChartInstance) return;
        
        const concludedWeight = this.timelineData
            .filter(t => t.status && t.status.toLowerCase() === 'concluido')
            .reduce((sum, task) => sum + this.getTaskWeight(task.title), 0);

        const inProgressWeight = this.timelineData
            .filter(t => t.status && t.status.toLowerCase() === 'em andamento')
            .reduce((sum, task) => sum + this.getTaskWeight(task.title), 0);

        const notStartedWeight = this.timelineData
            .filter(t => t.status && (t.status.toLowerCase() === 'n√£o iniciado' || t.status.toLowerCase() === 'nao iniciado'))
            .reduce((sum, task) => sum + this.getTaskWeight(task.title), 0);
        
        this.milestoneProgressChartInstance.data.datasets[0].data = [concludedWeight, inProgressWeight, notStartedWeight];
        this.milestoneProgressChartInstance.update();
    },
    
    updateVerticalsChart: function() {
        if (!this.verticalsChartInstance) return;
        this.verticalsChartInstance.data.labels = this.allVerticals.map(v => v.name);
        const percentages = this.allVerticals.map(vertical => {
            const verticalKey = vertical.key;
            const products = this.produtosPorVertical[verticalKey];
            if (!products) return 0;
            let totalTasks = 0, completedTasks = 0;
            products.forEach(product => {
                if (!this.produtosContratados.some(p => p.produto === product.name)) return;
                const productTasks = product.tasks.filter(task => !(task === task.toUpperCase() && !task.includes('(') && !task.includes('/')));
                const productSlug = product.name.toLowerCase().replace(/[\s()]/g, '-');
                const verticalSlug = verticalKey.toLowerCase();
                const taskKey = `projetos_${verticalSlug}-${productSlug}`;
                const customProductTasks = this.customTasks[taskKey] || [];
                totalTasks += productTasks.length + customProductTasks.length;
                completedTasks += document.querySelectorAll(`#projetos_${verticalSlug}-checklist-container input[id^="task-projetos_${verticalSlug}-${productSlug}"]:checked`).length;
            });
            return totalTasks > 0 ? (completedTasks / totalTasks) * 100 : 0;
        });
        this.verticalsChartInstance.data.datasets[0].data = percentages;
        this.verticalsChartInstance.update();
    },

    renderChecklists: function() {
        const milestonesList = document.getElementById('projetos_milestones-checklist');
        if (milestonesList) {
            milestonesList.innerHTML = '';
            this.timelineData.forEach(item => {
                const isChecked = item.status && item.status.toLowerCase() === 'concluido';
                milestonesList.innerHTML += `<div class="flex items-center checklist-item"><input type="checkbox" id="projetos_milestone-${item.id}" data-id="${item.id}" class="h-4 w-4 text-[#0761FF] border-slate-600 rounded focus:ring-[#0761FF] bg-transparent" ${isChecked ? 'checked' : ''}><label for="projetos_milestone-${item.id}" class="ml-2 block text-slate-300">${item.title}</label></div>`;
            });
            milestonesList.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const task = this.timelineData.find(t => t.id === parseInt(e.target.dataset.id, 10));
                    if (task) { task.status = e.target.checked ? 'Concluido' : 'Em andamento'; this.updateUI(); }
                });
            });
        }
        const documentsList = document.getElementById('projetos_documents-checklist');
        if (documentsList) {
            documentsList.innerHTML = '';
            this.documentsData.forEach((item, index) => {
                const isChecked = item.status && (item.status.toLowerCase() === 'recebido' || item.status.toLowerCase() === 'concluido');
                const linkAttrs = (!item.link || item.link === 'javascript:void(0);') ? 'href="#" class="ml-2 block text-slate-500 cursor-not-allowed"' : `href="${item.link}" target="_blank" rel="noopener noreferrer" class="ml-2 block text-slate-300 hover:text-[#0761FF] transition-colors"`;
                documentsList.innerHTML += `<div class="flex items-center checklist-item"><input type="checkbox" id="projetos_document-${index}" data-index="${index}" class="h-4 w-4 text-[#0761FF] border-slate-600 rounded focus:ring-[#0761FF] bg-transparent" ${isChecked ? 'checked' : ''}><a ${linkAttrs}>${item.name}</a></div>`;
            });
            documentsList.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const doc = this.documentsData[parseInt(e.target.dataset.index, 10)];
                    if (doc) { doc.status = e.target.checked ? 'Recebido' : 'Em aberto'; }
                });
            });
        }
    },

    renderVerticalProductPages: function(containerId, products, verticalSlug) {
        const container = document.getElementById(containerId);
        if (!container || !products) { if(container) container.innerHTML = '<p class="text-slate-400">Nenhum produto para esta vertical.</p>'; return; }
        container.innerHTML = '';
        const tabsContainer = document.createElement('div');
        tabsContainer.className = 'flex items-center gap-2 mb-6 border-b border-slate-700 pb-2 flex-wrap';
        const checklistContentContainer = document.createElement('div');
        products.forEach((product) => {
            const productSlug = product.name.toLowerCase().replace(/[\s()]/g, '-');
            const tab = document.createElement('button');
            tab.textContent = product.name;
            tab.className = 'product-tab';
            tab.dataset.target = `checklist-projetos_${verticalSlug}-${productSlug}`;
            if (!this.produtosContratados.some(p => p.produto === product.name)) {
                tab.classList.add('bg-red-900', 'hover:bg-red-800', 'text-slate-400', 'opacity-75');
                tab.title = "Produto n√£o contratado.";
            }
            const checklistDiv = document.createElement('div');
            checklistDiv.id = `checklist-projetos_${verticalSlug}-${productSlug}`;
            checklistDiv.className = 'product-checklist-content space-y-1 hidden';
            checklistDiv.innerHTML = `<div class="my-4"><h4 class="text-md font-semibold text-slate-300 mb-3">Rotinas para Verifica√ß√£o</h4><div class="flex items-center gap-2"><button class="mark-all-btn text-xs bg-sky-600 hover:bg-sky-700 text-white py-1 px-3 rounded-md">Marcar/Desmarcar Todos</button><button class="add-task-btn text-xs bg-emerald-600 hover:bg-emerald-700 text-white py-1 px-3 rounded-md">Adicionar Tarefa</button><button class="generate-report-btn text-xs bg-purple-600 hover:bg-purple-700 text-white py-1 px-3 rounded-md">Gerar Relat√≥rio</button></div></div>`;
            const tasksContainer = document.createElement('div');
            tasksContainer.className = "tasks-container";
            checklistDiv.appendChild(tasksContainer);
            let currentMacroGroup = null;
            product.tasks.forEach((task, taskIndex) => {
                const isHeader = task === product.tasks[taskIndex].toUpperCase() && !task.includes('(') && !task.includes('/');
                if (isHeader) {
                    currentMacroGroup = document.createElement('div');
                    currentMacroGroup.className = 'macro-group mt-4';
                    tasksContainer.appendChild(currentMacroGroup);
                    const headerId = `task-projetos_${verticalSlug}-${productSlug}-macro-${taskIndex}`;
                    currentMacroGroup.innerHTML = `<div class="flex items-center checklist-item"><input type="checkbox" id="${headerId}" class="h-4 w-4 text-[#0761FF] border-slate-600 rounded focus:ring-[#0761FF] bg-transparent macro-checkbox"><label for="${headerId}" class="ml-2 block text-slate-200 font-semibold text-md cursor-pointer">${task}</label></div>`;
                } else {
                    if (!currentMacroGroup) {
                        currentMacroGroup = document.createElement('div');
                        currentMacroGroup.className = 'macro-group no-header';
                        tasksContainer.appendChild(currentMacroGroup);
                    }
                    const taskId = `task-projetos_${verticalSlug}-${productSlug}-${taskIndex}`;
                    currentMacroGroup.innerHTML += `<div class="flex items-center checklist-item ml-4"><input type="checkbox" id="${taskId}" class="h-4 w-4 text-[#0761FF] border-slate-600 rounded focus:ring-[#0761FF] bg-transparent task-checkbox"><label for="${taskId}" class="ml-2 block text-slate-300 cursor-pointer">${task}</label></div>`;
                }
            });
            const taskKey = `projetos_${verticalSlug}-${productSlug}`;
            const customProductTasks = this.customTasks[taskKey] || [];
            if (customProductTasks.length > 0) {
                 if (!currentMacroGroup || !currentMacroGroup.classList.contains('no-header')) { currentMacroGroup = document.createElement('div'); currentMacroGroup.className = 'macro-group no-header'; tasksContainer.appendChild(currentMacroGroup); }
                 customProductTasks.forEach((task, taskIndex) => { currentMacroGroup.innerHTML += this.createCustomTaskHTML(task, taskKey, taskIndex); });
            }
            const notesContainer = document.createElement('div');
            notesContainer.className = 'mt-6';
            const currentNotes = this.productNotes[taskKey] || '';
            notesContainer.innerHTML = `<h4 class="text-md font-semibold text-slate-300 mb-2">Observa√ß√µes e Acordos</h4><textarea data-task-key="${taskKey}" class="notes-textarea w-full p-2 border rounded-md bg-slate-700 border-slate-600" rows="4" placeholder="Digite aqui as observa√ß√µes...">${currentNotes}</textarea>`;
            checklistDiv.appendChild(notesContainer);
            checklistContentContainer.appendChild(checklistDiv);
            this.setupVerticalEventListeners(checklistDiv, verticalSlug, productSlug, product);
            tab.addEventListener('click', () => {
                tabsContainer.querySelectorAll('.product-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                checklistContentContainer.querySelectorAll('.product-checklist-content').forEach(c => c.classList.add('hidden'));
                document.getElementById(tab.dataset.target).classList.remove('hidden');
            });
            tabsContainer.appendChild(tab);
        });
        container.appendChild(tabsContainer);
        container.appendChild(checklistContentContainer);
        const firstContractedTab = [...tabsContainer.querySelectorAll('.product-tab')].find(tab => !tab.classList.contains('bg-red-900')) || tabsContainer.firstChild;
        if (firstContractedTab) { firstContractedTab.click(); }
    },

    setupVerticalEventListeners: function(checklistDiv, verticalSlug, productSlug, product) {
        checklistDiv.querySelectorAll('.macro-checkbox').forEach(cb => cb.addEventListener('change', (e) => {
            const group = e.target.closest('.macro-group');
            group.querySelectorAll('.task-checkbox').forEach(childCb => { childCb.checked = e.target.checked; });
            this.updateVerticalsChart();
        }));
        checklistDiv.querySelectorAll('.task-checkbox').forEach(cb => cb.addEventListener('change', () => {
            const group = cb.closest('.macro-group');
            const macroCb = group.querySelector('.macro-checkbox');
            if (macroCb) {
                const allChecked = [...group.querySelectorAll('.task-checkbox')].every(c => c.checked);
                macroCb.checked = allChecked;
            }
            this.updateVerticalsChart();
        }));
        checklistDiv.querySelector('.mark-all-btn').addEventListener('click', () => {
            const checkboxes = checklistDiv.querySelectorAll('input[type="checkbox"]');
            if (checkboxes.length === 0) return;
            const shouldCheckAll = [...checkboxes].some(cb => !cb.checked);
            checkboxes.forEach(cb => { cb.checked = shouldCheckAll; });
            this.updateVerticalsChart();
        });
        checklistDiv.querySelector('.add-task-btn').addEventListener('click', () => {
            const taskName = prompt("Digite o nome da nova tarefa:");
            const taskKey = `projetos_${verticalSlug}-${productSlug}`;
            if (taskName && taskName.trim() !== "") {
                this.customTasks[taskKey] = this.customTasks[taskKey] || [];
                this.customTasks[taskKey].push(taskName.trim());
                localStorage.setItem('projetos_customTasks', JSON.stringify(this.customTasks));
                
                const tasksContainer = checklistDiv.querySelector('.tasks-container');
                let lastGroup = tasksContainer.querySelector('.macro-group:last-child.no-header');
                if(!lastGroup){ lastGroup = document.createElement('div'); lastGroup.className = 'macro-group no-header'; tasksContainer.appendChild(lastGroup); }
                const newTaskIndex = this.customTasks[taskKey].length - 1;
                lastGroup.insertAdjacentHTML('beforeend', this.createCustomTaskHTML(taskName.trim(), taskKey, newTaskIndex));
                const newElem = lastGroup.lastElementChild;
                newElem.querySelector('input[type="checkbox"]').addEventListener('change', () => this.updateVerticalsChart());
                newElem.querySelector('.delete-custom-task-btn').addEventListener('click', (e) => this.handleDeleteCustomTask(e));
                this.updateVerticalsChart();
            }
        });
        checklistDiv.querySelector('.generate-report-btn').addEventListener('click', () => {
            const taskKey = `projetos_${verticalSlug}-${productSlug}`;
            const checkedItems = [];
            checklistDiv.querySelectorAll('.task-checkbox:checked, .macro-checkbox:checked').forEach(cb => { if (cb.nextElementSibling) checkedItems.push(cb.nextElementSibling.textContent.trim()); });
            const notes = this.productNotes[taskKey] || '';
            const verticalData = this.allVerticals.find(v => v.key === verticalSlug);
            this.generateHomologationReport(product.name, verticalData.name, checkedItems, notes);
        });
        checklistDiv.querySelector('.notes-textarea').addEventListener('input', (e) => {
            const taskKey = e.target.dataset.taskKey;
            this.productNotes[taskKey] = e.target.value;
            localStorage.setItem('projetos_productNotes', JSON.stringify(this.productNotes));
        });
        checklistDiv.querySelectorAll('.delete-custom-task-btn').forEach(btn => btn.addEventListener('click', (e) => this.handleDeleteCustomTask(e)));
    },

    createCustomTaskHTML: function(taskName, taskKey, taskIndex) {
        return `<div class="flex items-center justify-between checklist-item ml-4 group"><div class="flex items-center"><input type="checkbox" id="task-${taskKey}-custom-${taskIndex}" class="h-4 w-4 text-[#0761FF] border-slate-600 rounded focus:ring-[#0761FF] bg-transparent task-checkbox"><label for="task-${taskKey}-custom-${taskIndex}" class="ml-2 block text-teal-300 italic cursor-pointer">${taskName}</label></div><button data-task-key="${taskKey}" data-task-index="${taskIndex}" class="delete-custom-task-btn text-red-500 hover:text-red-400 text-xs opacity-0 group-hover:opacity-100">&#x2715;</button></div>`;
    },

    handleDeleteCustomTask: function(e) {
        const button = e.currentTarget;
        const taskKey = button.dataset.taskKey;
        const taskIndex = parseInt(button.dataset.taskIndex, 10);
        if (this.customTasks[taskKey] && this.customTasks[taskKey][taskIndex] !== undefined) {
            this.customTasks[taskKey].splice(taskIndex, 1);
            localStorage.setItem('projetos_customTasks', JSON.stringify(this.customTasks));
            button.closest('.checklist-item').remove();
            this.updateVerticalsChart();
        }
    },

    renderKanbanBoard: function() {
        const kanbanContainer = document.getElementById('projetos_kanban-board');
        if (!kanbanContainer || !this.timelineData.length) return;
        kanbanContainer.innerHTML = '';
        const firstMilestone = this.timelineData[0]?.title || 'Planejamento';
        this.allVerticals.forEach(v => {
            if (!this.verticalsKanbanStatus[v.name]) { this.verticalsKanbanStatus[v.name] = firstMilestone; }
        });
        localStorage.setItem('projetos_verticalsKanbanStatus', JSON.stringify(this.verticalsKanbanStatus));
        const milestones = [...new Set(this.timelineData.map(t => t.title))];
        milestones.forEach(milestone => {
            const columnEl = document.createElement('div');
            columnEl.className = 'p-4 rounded-lg bg-slate-800 kanban-column flex-shrink-0 w-72';
            columnEl.dataset.milestone = milestone;
            const cardsHtml = this.allVerticals.filter(v => this.verticalsKanbanStatus[v.name] === milestone)
                .map(v => `<div class="bg-slate-700 p-3 rounded-md shadow-sm kanban-card" draggable="true" data-vertical="${v.name}"><h4 class="font-bold text-slate-200 flex items-center"><span class="w-3 h-3 rounded-full ${v.color} mr-2"></span>${v.name}</h4></div>`).join('');
            columnEl.innerHTML = `<h3 class="text-lg font-bold text-slate-200 mb-4">${milestone}</h3><div class="space-y-3 min-h-[100px]">${cardsHtml}</div>`;
            kanbanContainer.appendChild(columnEl);
        });
    },

    getPriorityClass: function(priority) {
        if(!priority) return 'bg-slate-700 text-slate-300';
        switch (priority.toLowerCase()) {
            case 'cr√≠tica': return 'bg-red-900/50 text-red-300';
            case 'alta': return 'bg-orange-900/50 text-orange-300';
            case 'moderada': return 'bg-sky-900/50 text-sky-300';
            default: return 'bg-slate-700 text-slate-300';
        }
    },

    renderRisksTable: function(risksToRender) {
        const tableBody = document.getElementById('projetos_risks-table-body');
        tableBody.innerHTML = '';
        if (!risksToRender || risksToRender.length === 0) { tableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-slate-400">Nenhum risco encontrado.</td></tr>'; return; }
        risksToRender.forEach(risk => {
            const priorityClass = this.getPriorityClass(risk.prioridade);
            tableBody.innerHTML += `<tr class="hover:bg-slate-700 cursor-pointer"><td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-50">${risk.id}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-slate-400">${risk.resumo}</td><td class="px-6 py-4 whitespace-nowrap text-sm"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${priorityClass}">${risk.prioridade}</span></td><td class="px-6 py-4 whitespace-nowrap text-sm"><select class="p-1 border rounded-md text-sm bg-slate-700 border-slate-600" data-risk-id="${risk.id}"><option value="Em Aberto" ${risk.status === 'Em Aberto' ? 'selected' : ''}>Em Aberto</option><option value="Monitorando" ${risk.status === 'Monitorando' ? 'selected' : ''}>Monitorando</option><option value="Controlado" ${risk.status === 'Controlado' ? 'selected' : ''}>Controlado</option></select></td></tr>`;
        });
        tableBody.querySelectorAll('tr').forEach(row => row.addEventListener('click', (e) => { if (e.target.tagName === 'SELECT') return; document.querySelectorAll('#projetos_risks-table-body tr').forEach(r => r.classList.remove('bg-slate-600')); e.currentTarget.classList.add('bg-slate-600'); }));
    },

    setupRiskFilters: function() {
        const priorityFilter = document.getElementById('projetos_priorityFilter');
        const statusFilter = document.getElementById('projetos_statusFilter');
        priorityFilter.innerHTML = '<option value="all">Toda Prioridade</option>' + [...new Set(this.allRisks.map(r => r.prioridade))].map(p => `<option value="${p}">${p}</option>`).join('');
        statusFilter.innerHTML = '<option value="all">Todo Status</option>' + [...new Set(this.allRisks.map(r => r.status))].map(s => `<option value="${s}">${s}</option>`).join('');
        [priorityFilter, statusFilter].forEach(filter => filter.addEventListener('change', () => {
            const selectedPriority = priorityFilter.value, selectedStatus = statusFilter.value;
            const filteredRisks = this.allRisks.filter(risk => (selectedPriority === 'all' || risk.prioridade === selectedPriority) && (selectedStatus === 'all' || risk.status === selectedStatus));
            this.renderRisksTable(filteredRisks);
        }));
    },
    
    setupLessonsLearned: function() {
        document.getElementById('projetos_add-lesson-btn').addEventListener('click', () => {
            const lessonInput = document.getElementById('projetos_lesson-input'), contextInput = document.getElementById('projetos_lesson-context'), resolutionInput = document.getElementById('projetos_lesson-resolution-input'), categorySelect = document.getElementById('projetos_lesson-category');
            const lessonText = lessonInput.value.trim(), contextText = contextInput.value.trim(), resolutionText = resolutionInput.value.trim(), categoryText = categorySelect.value;
            lessonInput.classList.toggle('border-red-500', !lessonText); contextInput.classList.toggle('border-red-500', !contextText);
            if (lessonText && contextText) {
                this.lessonsLearnedData.push({ id: Date.now(), lesson: lessonText, resolution: resolutionText, context: contextText, category: categoryText });
                localStorage.setItem('projetos_lessonsLearnedData', JSON.stringify(this.lessonsLearnedData));
                lessonInput.value = ''; contextInput.value = ''; resolutionInput.value = '';
                lessonInput.classList.remove('border-red-500'); contextInput.classList.remove('border-red-500');
                this.renderLessonsLearned();
            }
        });
    },

    renderLessonsLearned: function() {
        const tableBody = document.getElementById('projetos_lessons-table-body');
        if (!tableBody) return;
        tableBody.innerHTML = '';
        if (this.lessonsLearnedData.length === 0) { tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-slate-400">Nenhuma li√ß√£o aprendida.</td></tr>'; return; }
        this.lessonsLearnedData.forEach(item => {
            tableBody.innerHTML += `<tr data-id="${item.id}"><td class="px-6 py-4 whitespace-normal text-sm text-slate-400">${item.lesson}</td><td class="px-6 py-4 whitespace-normal text-sm text-slate-400">${item.resolution}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-slate-400">${item.context}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-slate-400">${item.category}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-center"><button class="text-red-500 hover:text-red-700 delete-lesson-btn" data-id="${item.id}">Remover</button></td></tr>`;
        });
        document.querySelectorAll('#projetos_lessons-table-body .delete-lesson-btn').forEach(button => button.addEventListener('click', (e) => {
            const idToDelete = parseInt(e.target.dataset.id, 10);
            this.lessonsLearnedData = this.lessonsLearnedData.filter(item => item.id !== idToDelete);
            localStorage.setItem('projetos_lessonsLearnedData', JSON.stringify(this.lessonsLearnedData));
            this.renderLessonsLearned();
        }));
        this.setupExportButtons();
    },

    setupNextSteps: function() {
        document.getElementById('projetos_add-next-step-btn').addEventListener('click', () => {
            const descIn = document.getElementById('projetos_next-step-input'), respIn = document.getElementById('projetos_next-step-responsible'), dateIn = document.getElementById('projetos_next-step-date');
            const description = descIn.value.trim(), responsible = respIn.value.trim(), date = dateIn.value;
            descIn.classList.toggle('border-red-500', !description); respIn.classList.toggle('border-red-500', !responsible); dateIn.classList.toggle('border-red-500', !date);
            if (description && responsible && date) {
                this.nextStepsData.push({ id: Date.now(), description, responsible, date, status: 'Aberto' });
                localStorage.setItem('projetos_nextStepsData', JSON.stringify(this.nextStepsData));
                descIn.value = ''; respIn.value = ''; dateIn.value = '';
                [descIn, respIn, dateIn].forEach(el => el.classList.remove('border-red-500'));
                this.renderNextSteps('Aberto');
            }
        });
    },

    renderNextSteps: function(filter = 'Aberto') {
        const container = document.getElementById('projetos_next-steps-container');
        if (!container) return;
        container.innerHTML = `<div id="projetos_next-steps-tabs" class="flex border-b border-slate-700 mb-4"><button class="next-steps-tab" data-filter="Aberto">Abertas</button><button class="next-steps-tab" data-filter="Concluido">Conclu√≠das</button><button class="next-steps-tab" data-filter="Atrasado">Atrasadas</button></div><div class="overflow-x-auto"><table class="min-w-full divide-y divide-slate-700"><thead class="bg-slate-700"><tr><th class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider w-2/5">A√ß√£o</th><th class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Respons√°vel</th><th class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Data</th><th class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Status</th><th class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">A√ß√µes</th></tr></thead><tbody id="projetos_next-steps-table-body" class="bg-slate-800 divide-y divide-slate-700"></tbody></table></div>`;
        const tableBody = container.querySelector('#projetos_next-steps-table-body'), now = luxon.DateTime.now().startOf('day');
        let filteredData = (filter === 'Atrasado') ? this.nextStepsData.filter(item => item.status === 'Aberto' && luxon.DateTime.fromISO(item.date) < now) : this.nextStepsData.filter(item => item.status === filter);
        if (filteredData.length === 0) { tableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-slate-400">Nenhuma tarefa encontrada.</td></tr>`; }
        else {
            tableBody.innerHTML = filteredData.map(item => {
               const isAtrasado = item.status === 'Aberto' && luxon.DateTime.fromISO(item.date) < now;
               const statusClass = item.status === 'Concluido' ? 'text-emerald-400' : (isAtrasado ? 'text-red-400' : 'text-yellow-400');
               const statusText = item.status === 'Concluido' ? 'Conclu√≠do' : (isAtrasado ? 'Atrasado' : 'Aberto');
              return `<tr data-id="${item.id}"><td class="px-6 py-4 whitespace-normal text-sm text-slate-400">${item.description}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-slate-400">${item.responsible}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-slate-400">${luxon.DateTime.fromISO(item.date).toFormat('dd/MM/yyyy')}</td><td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${statusClass}">${statusText}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-center">${item.status !== 'Concluido' ? `<button class="text-emerald-500 hover:text-emerald-700 complete-next-step-btn" data-id="${item.id}">Concluir</button>` : ''}<button class="text-red-500 hover:text-red-700 delete-next-step-btn ml-2" data-id="${item.id}">Remover</button></td></tr>`;
            }).join('');
        }
        container.querySelectorAll('.next-steps-tab').forEach(tab => { tab.classList.toggle('active', tab.dataset.filter === filter); tab.addEventListener('click', () => this.renderNextSteps(tab.dataset.filter)); });
        container.querySelectorAll('.delete-next-step-btn').forEach(btn => btn.addEventListener('click', (e) => { this.nextStepsData = this.nextStepsData.filter(i => i.id !== parseInt(e.target.dataset.id, 10)); localStorage.setItem('projetos_nextStepsData', JSON.stringify(this.nextStepsData)); this.renderNextSteps(filter); }));
        container.querySelectorAll('.complete-next-step-btn').forEach(btn => btn.addEventListener('click', (e) => { const task = this.nextStepsData.find(i => i.id === parseInt(e.target.dataset.id, 10)); if(task) task.status = 'Concluido'; localStorage.setItem('projetos_nextStepsData', JSON.stringify(this.nextStepsData)); this.renderNextSteps(filter); }));
        this.setupExportButtons();
    },

    setupRiskListeners: function() {
        const generateActionBtn = document.getElementById('projetos_generate-action-btn');
        generateActionBtn.addEventListener('click', async () => {
            if (this.isFetching) return;
            const mitigationActionBox = document.getElementById('projetos_mitigation-action-box');
            const mitigationActionText = document.getElementById('projetos_mitigation-action-text');
            const selectedRow = document.querySelector('#projetos_risks-table-body .bg-slate-600');
            if (!selectedRow) { mitigationActionText.textContent = 'Por favor, selecione um risco.'; mitigationActionBox.classList.remove('hidden'); return; }
            const risk = this.allRisks.find(r => r.id == parseInt(selectedRow.querySelector('td').textContent));
            if (!risk) return;
            this.isFetching = true;
            mitigationActionText.textContent = 'Gerando plano de a√ß√£o...';
            mitigationActionBox.classList.remove('hidden');
            generateActionBtn.disabled = true; generateActionBtn.classList.add('opacity-50');
            try {
                const prompt = `Como um gerente de projetos s√™nior, forne√ßa um plano de a√ß√£o conciso e pr√°tico para mitigar o seguinte risco: Resumo do risco: "${risk.resumo}". Prioridade: "${risk.prioridade}". O plano de a√ß√£o deve ser objetivo, com 3 a 5 passos pr√°ticos em formato de lista.`;
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=`;
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const result = await response.json();
                if (result.candidates?.[0]?.content.parts?.[0]) { mitigationActionText.innerHTML = result.candidates[0].content.parts[0].text.replace(/\n/g, '<br>'); }
                else { mitigationActionText.textContent = 'N√£o foi poss√≠vel gerar um plano de a√ß√£o.'; }
            } catch (error) { console.error("Gemini API Error:", error); mitigationActionText.textContent = 'Erro ao conectar com o servi√ßo de IA.';
            } finally { this.isFetching = false; generateActionBtn.disabled = false; generateActionBtn.classList.remove('opacity-50'); }
        });
    },

    setupKanbanListeners: function() {
        let draggedCard = null;
        const kanbanContainer = document.getElementById('projetos_kanban-board');
        kanbanContainer.addEventListener('dragstart', e => { if (e.target.classList.contains('kanban-card')) { draggedCard = e.target; setTimeout(() => e.target.classList.add('dragging'), 0); } });
        kanbanContainer.addEventListener('dragend', e => { if (draggedCard && e.target.classList.contains('kanban-card')) { draggedCard.classList.remove('dragging'); draggedCard = null; } });
        kanbanContainer.addEventListener('dragover', e => e.preventDefault());
        kanbanContainer.addEventListener('drop', e => {
            e.preventDefault();
            if (draggedCard) {
                const column = e.target.closest('.kanban-column');
                if (column) {
                    const newMilestone = column.dataset.milestone;
                    const verticalName = draggedCard.dataset.vertical;
                    this.verticalsKanbanStatus[verticalName] = newMilestone;
                    localStorage.setItem('projetos_verticalsKanbanStatus', JSON.stringify(this.verticalsKanbanStatus));
                    column.querySelector('.space-y-3').appendChild(draggedCard);
                }
            }
        });
    },

    setupExportButtons: function() {
        const exportLessonsBtn = document.getElementById('projetos_export-lessons-btn');
        const exportNextStepsBtn = document.getElementById('projetos_export-next-steps-btn');
        exportLessonsBtn.disabled = this.lessonsLearnedData.length === 0;
        exportNextStepsBtn.disabled = this.nextStepsData.length === 0;
        const convertToCSV = (data) => {
            if (data.length === 0) return '';
            const headers = Object.keys(data[0]);
            const csvRows = [headers.join(',')];
            for (const row of data) {
                const values = headers.map(header => `"${(''+row[header]).replace(/"/g, '""')}"`);
                csvRows.push(values.join(','));
            }
            return csvRows.join('\n');
        };
        const downloadCSV = (csvString, filename) => {
            const blob = new Blob(["\uFEFF" + csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.setAttribute('href', URL.createObjectURL(blob));
            link.setAttribute('download', filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };
        exportLessonsBtn.onclick = () => { if (this.lessonsLearnedData.length > 0) downloadCSV(convertToCSV(this.lessonsLearnedData), 'licoes_aprendidas.csv'); };
        exportNextStepsBtn.onclick = () => { if (this.nextStepsData.length > 0) { const renamedData = this.nextStepsData.map(item => ({ A√ß√£o: item.description, Respons√°vel: item.responsible, Data: item.date, Status: item.status })); downloadCSV(convertToCSV(renamedData), 'proximos_passos.csv'); } };
    },
    
    initCharts: function() {
        const createOrUpdateChart = (instance, ctx, config) => { if (instance) instance.destroy(); return new Chart(ctx, config); };
        const priorityData = this.allRisks.reduce((acc, risk) => { if(risk.prioridade) acc[risk.prioridade] = (acc[risk.prioridade] || 0) + 1; return acc; }, {});
        const originData = this.allRisks.reduce((acc, risk) => { if(risk.origem) acc[risk.origem] = (acc[risk.origem] || 0) + 1; return acc; }, {});
        
        const priorityCtx = document.getElementById('projetos_priorityChart')?.getContext('2d');
        if (priorityCtx) this.priorityChartInstance = createOrUpdateChart(this.priorityChartInstance, priorityCtx, { type: 'doughnut', data: { labels: Object.keys(priorityData), datasets: [{ data: Object.values(priorityData), backgroundColor: ['#ef4444', '#f97316', '#0761FF', '#475569'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } } } });

        const originCtx = document.getElementById('projetos_originChart')?.getContext('2d');
        if (originCtx) this.originChartInstance = createOrUpdateChart(this.originChartInstance, originCtx, { type: 'bar', data: { labels: Object.keys(originData), datasets: [{ label: 'N¬∫ de Riscos', data: Object.values(originData), backgroundColor: '#0761FF' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } } });
        
        const milestoneProgressCtx = document.getElementById('projetos_milestoneProgressChart')?.getContext('2d');
        if (milestoneProgressCtx) this.milestoneProgressChartInstance = createOrUpdateChart(this.milestoneProgressChartInstance, milestoneProgressCtx, { type: 'doughnut', data: { labels: ['Conclu√≠do', 'Em Andamento', 'N√£o Iniciado'], datasets: [{ data: [0, 0, 0], backgroundColor: ['#22c55e', '#f97316', '#d1d5db'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } } });

        const verticalsCtx = document.getElementById('projetos_verticalsChart')?.getContext('2d');
        if (verticalsCtx) this.verticalsChartInstance = createOrUpdateChart(this.verticalsChartInstance, verticalsCtx, { type: 'bar', data: { labels: this.allVerticals.map(v => v.name), datasets: [{ label: '% Conclu√≠do', data: [], backgroundColor: ['#0761FF', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#6366f1'] }] }, options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true, max: 100, ticks: { callback: v => `${v}%` } } } } });
        
        this.updateUI();
    },
    
    updateStatusLight: function() {
        const indicator = document.getElementById('projetos_status-light-indicator');
        const text = document.getElementById('projetos_status-light-text');
        const lastTask = this.timelineData[this.timelineData.length - 1];
        if (!lastTask || !lastTask.endDate) { indicator.className = 'w-4 h-4 rounded-full mr-2 bg-slate-500'; text.textContent = 'Indefinido'; return; }
        const daysRemaining = luxon.DateTime.fromISO(lastTask.endDate).diff(luxon.DateTime.now(), 'days').toObject().days;
        if (daysRemaining < 0) { indicator.className = 'w-4 h-4 rounded-full mr-2 bg-red-500'; text.textContent = 'Atrasado'; }
        else if (daysRemaining <= 30) { indicator.className = 'w-4 h-4 rounded-full mr-2 bg-yellow-500'; text.textContent = 'Aten√ß√£o'; }
        else { indicator.className = 'w-4 h-4 rounded-full mr-2 bg-emerald-500'; text.textContent = 'Em Dia'; }
    },

    updateUI: function() {
        this.updateMilestoneChart();
        this.updateVerticalsChart();
        this.updateStatusLight();
        this.renderTimeline(document.getElementById('projetos_timeline-container'), this.timelineData);
    },
    
    generateHomologationReport: function(productName, verticalName, checkedItems, notes) {
        const { jsPDF } = window.jspdf; const doc = new jsPDF();
        doc.setFontSize(18); doc.setFont('helvetica', 'bold'); doc.text('Aceite de Homologa√ß√£o', 105, 20, { align: 'center' });
        doc.setFontSize(12); doc.setFont('helvetica', 'normal');
        doc.text(`Projeto: ${this.projectData.projectName || 'N/A'}`, 20, 40); doc.text(`Vertical: ${verticalName}`, 20, 48);
        doc.text(`Produto: ${productName}`, 20, 56); doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, 20, 64);
        doc.setFontSize(14); doc.setFont('helvetica', 'bold'); doc.text('Itens Verificados:', 20, 80);
        doc.setFontSize(10); doc.setFont('helvetica', 'normal');
        let y = 88; const pageH = doc.internal.pageSize.height, margin = 20;
        if (checkedItems.length === 0) { doc.text('- Nenhum item verificado.', 25, y); y += 8; }
        else { checkedItems.forEach(item => { if (y > pageH - margin) { doc.addPage(); y = margin; } const splitItem = doc.splitTextToSize(`- ${item}`, 160); doc.text(splitItem, 25, y); y += (splitItem.length * 5) + 2; }); }
        y += 10;
        if (y > pageH - margin - 20) { doc.addPage(); y = margin; }
        doc.setFontSize(14); doc.setFont('helvetica', 'bold'); doc.text('Acordos / Observa√ß√µes:', 20, y); y += 8;
        doc.setFontSize(10); doc.setFont('helvetica', 'normal');
        const notesText = notes.trim() === '' ? 'Nenhuma observa√ß√£o ou acordo registrado.' : notes;
        const splitNotes = doc.splitTextToSize(notesText, 170);
        if (y + (splitNotes.length * 5) > pageH - margin) { doc.addPage(); y = margin; }
        doc.text(splitNotes, 20, y);
        y = pageH - 40;
        doc.text('___________________________________', 20, y); doc.text('Assinatura do Cliente', 20, y + 5);
        doc.text('___________________________________', 110, y); doc.text('Assinatura do Gerente de Projeto', 110, y + 5);
        doc.save(`Aceite_Homologacao_${productName.replace(/[\s()]/g, '_')}.pdf`);
    },

    getFixedChecklistData: function() {
        const data = {'arrecadacao':[{name:'Tributos (Cloud)',tasks:['M√≥dulo Cadastral - Endere√ßo','Tabelas Auxiliares','FINANCEIRO - D√âBITOS','RECEITAS TRIBUT√ÅRIAS','FINANCEIRO - DIVIDA ATIVA','FINANCEIRO - Parcelamentos','FINANCEIRO - RENDAS DIVERSAS','ALVAR√ÅS','GUIAS DE EMISS√ÉO - IPTU','GUIAS DE EMISS√ÉO - ALVAR√Å','GUIAS DE EMISS√ÉO - GERAL','RELAT√ìRIO DIVERSOS','CONV√äNIOS - CONTABILIDADE','BAIXAS - DAF607','ITBI','C√ÅLCULO DE IPTU','CALCULO DE ALV√ÅRA','C√ÅLCULO DE ISSQN FIXO','C√ÅLCULO DE CEMIT√âRIO']},{name:'e-Nota (Cloud)',tasks:['Cadastros de empresas','Org√£oes relulamentadores','Leis municipais']},{name:'Procuradoria (Cloud)',tasks:['CADASTROS AUXILIARES','D√çVIDA ATIVA','PROCESSOS','PRESTA√á√ÉO DE CONTAS']}],
            'compras':[{name:'Compras (Cloud)',tasks:['PAR√ÇMETROS GERAIS','SCRIPTS DE INTERA√á√ÉO','PORTAIS DE DIVULGA√á√ÉO','MODELO DE RELAT√ìRIOS','CASAS DECIMAIS','PLATAFORMAS DE INFORMA√á√ïES ELETR√îNICAS','ESTRUTURA ORGANIZACIONAL','CAT√ÅLOGO','OR√áAMENTO','PESSOAS','BANC√ÅRIOS','ATOS','INFORMA√á√ïES DE ENTREGA','CADASTROS AUXILIARES','SOLICITA√á√ïES DE COMPRA','COTA√á√ÉO DE PRE√áOS','PROCESSOS','Processos Administrativos','REGISTROS DE PRE√áOS','INTEGRA√á√ïES ENTRE SISTEMAS','PRESTA√á√ÉO DE CONTAS']},{name:'Contratos (Cloud)',tasks:['CONFIGURA√á√ïES DO SISTEMA','ESTRUTURA ORGANIZACIONAL','CAT√ÅLOGO','OR√áAMENTO','PESSOAS','BANC√ÅRIOS','COMPROVANTES','INFORMA√á√ïES DE ENTREGA','CADASTROS AUXILIARES','Compras diretas (Abas gestor e Participante)','Contrata√ß√µes (Abas gestor e Participante)','Atas de registro de pre√ßos']},{name:'Almoxarifado',tasks:['PAR√ÇMETROS GERAIS','M√âTRICAS','ESTRUTURA ORGANIZACIONAL','CAT√ÅLOGO','PESSOAS','CADASTROS AUXILIARES','ENDERE√áOS','ATOS','Requisi√ß√µes de materiais (Em edi√ß√£o, cancelados e n√£o autorizados)','Requisi√ß√µes entre almoxarifados (Em edi√ß√£o, cancelados e n√£o autorizados)','ENTRADAS','SA√çDAS','TRANSFER√äNCIAS','INVENT√ÅRIOS','ENCERRAMENTOS','PRESTA√á√ÉO DE CONTAS']},{name:'Frotas (Cloud)',tasks:['PAR√ÇMETROS GERAIS','APLICATIVO','ESTRUTURA ORGANIZACIONAL','CAT√ÅLOGO','VE√çCULOS E EQUIPAMENTOS','PESSOAS','ENDERE√áOS','Reservas de ve√≠culos','Viagens','Despesas','Taxas e licenciamentos','Multas de tr√¢nsito','PRESTA√á√ÉO DE CONTAS','Itens de Edital']},{name:'Patrim√¥nio (Cloud)',tasks:['PAR√ÇMETROS GERAIS','M√âTODOS DE DEPRECIA√á√ÉO','ESTRUTURA ORGANIZACIONAL','CAT√ÅLOGO','PESSOAS','SEGUROS','ATOS','MOVIMENTOS DE BENS','Bens']},{name:'Obras',tasks:['CADASTROS AUXILIARES','Tipos de obras (Descri√ß√£o)','Classifica√ß√µes (Descri√ß√£o)','Atos (N√∫mero e descri√ß√£o)','Tipos de execu√ß√£o (Descri√ß√£o)','Categorias (Descri√ß√£o)','Tipos de empreitadas (Descri√ß√£o)','OBRAS','Todas (Descri√ß√£o, objeto, data, organograma, prazo da conclus√£o, tipo de obra, classifica√ß√£o, quantidade, unidade de medida, ato, categoria, tipo de execu√ß√£o, obra/ projeto, tipo de empreitada, obra destinada para, popula√ß√£o atendida, endere√ßos e posi√ß√£o geogr√°fica)','N√£o iniciadas','Em andamento','Paralisadas','Conclu√≠das','PRESTA√á√ÉO DE CONTAS']}],
            'contabil':[{name:'Planejamento (Cloud)',tasks:['PLANEJAMENTO','PPA (Composi√ß√£o da receita e despesa, Composi√ß√£o da receita, Composi√ß√£o da despesa)','LDO (Composi√ß√£o da receita e despesa, Composi√ß√£o da receita, Composi√ß√£o da despesa e N√≠vel da natureza da despesa)','LOA (Composi√ß√£o da receita, N√≠vel da natureza da despesa, Gerar n√∫mero reduzido para...)','FUNCIONAL PROGRAM√ÅTICA','Programas','Configura√ß√£o de funcionais','A√ß√µes (PPA, LDO, LOA)','PESSOAS','ASSINATURAS','INDICADORES','ESTRUTURA ORGANIZACIONAL','BASE ESTRAT√âGICA','ATOS','CONTROLE','Localizadores','NATUREZAS','Receita (N√∫mero, tipo, descri√ß√£o, marcadores e campos adicionais)','Despesa (N√∫mero, tipo, descri√ß√£o, marcadores e campos adicionais)','CADASTROS AUXILIARES','Solicita√ß√µes de despesas','Altera√ß√µes or√ßament√°rias da despesa','PROCESSOS']},{name:'Contabilidade (Cloud)',tasks:['PAR√ÇMETROS GERAIS','SCRIPTS DE INTERA√á√ÉO','PORTAIS DE DIVULGA√á√ÉO','PLANO DE CONTAS','OR√áAMENTO','Relat√≥rios (Descri√ß√£o, Configura√ß√£o, Fonte de Dados, Campo, Filtro, Documentos)','Equival√™ncias (Conta Cont√°bil, Classifica√ß√£o)','Itens de equival√™ncia (Descri√ß√£o, Documento, Campo, Item)','Processos (Configura√ß√£o, Descri√ß√£o, Tipo, Script)','FUNCIONAL PROGRAM√ÅTICA','PESSOAS','ASSINATURAS','ATOS','ESTRUTURA ORGANIZACIONAL','NATUREZAS','CONTROLE','BANC√ÅRIOS','CADASTROS AUXILIARES','RECEITA','CONTROLE','INTERA√á√ïES','DESPESA','PROGRAMA√á√ÉO FINANCEIRA','PER√çODO FINANCEIRO','ESCRITURANDO','PRESTA√á√ÉO DE CONTAS']},{name:'Tesouraria (Cloud)',tasks:['PAR√ÇMETROS GERAIS','IMPLANTA√á√ÉO','BANC√ÅRIOS','CONTROLE','PESSOAS','ESTRUTURA ORGANIZACIONAL','ASSINATURAS','CADASTROS AUXILIARES','PROCESSOS','Pagamentos']},{name:'Conv√™nios',tasks:['CADASTROS AUXILIARES','Tipos de comprovantes (Descri√ß√£o e tipo)','Tipos de aditivos (Descri√ß√£o, classifica√ß√£o e tipo)','CONV√äNIOS','Recebidos (N√∫mero, valor do repasse, valor de contrapartida, valor global, objeto, per√≠odo, data da assinatura, conta banc√°ria, modalidade, concedente, ato autorizativo, certid√µes, respons√°veis, anexos e campos adicionais)','Repassados','Formaliza√ß√£o e execu√ß√£o (Conv√™nios e aditivos)','Presta√ß√£o de contas (A comprovar, em comprova√ß√£o e comprovado)']}],
            'pessoal':[{name:'Folha (Cloud)',tasks:['CADASTRO DE ENTIDADE','CADASTRO DE GRUPOS FUNCIONAIS','CADASTRO DE ORGANOGRAMAS','CADASTRO DE LOTA√á√ïES F√çSICAS','CADASTRO DE ATOS','CADASTRO DE QUADRO DE CARGOS','CADASTRO DE CARGOS','CADASTRO DE √ÅREAS DE ATUA√á√ÉO','CADASTRO DE PLANOS DE CARGOS E SAL√ÅRIOS','CADASTRO DE N√çVEIS SALARIAIS','CADASTRO DE MANUTEN√á√ÉO DE ESTABELECIMENTOS','CADASTRO DE TIPOS DE BASES','CADASTRO DE EVENTOS','CADASTRO DE M√âDIAS E VANTAGENS','CONFIGURA√á√ÉO DE PROVIS√ÉO','CADASTRO DE CONCURSO','CADASTRO DE VINCULOS EMPREGAT√çCIOS','CADASTRO DE PLANOS DE PREVID√äNCIA E ASSIST√äNCIA','CADASTRO DE TIPOS DE ADMINISTRA√á√ÉO','CADASTRO DE ENDERE√áOS (Definidos pelo usu√°rio)','CADASTRO DE PESSOAS','CADASTRO DE MATR√çCULAS']},{name:'Recursos Humanos (Cloud)',tasks:['ESTRUTURA ORGANIZACIONAL','BANC√ÅRIOS','CADASTROS AUXILIARES','GEST√ÉO DE QUADRO','GEST√ÉO DE PESSOAS','ADMISS√ÉO DIGITAL','F√âRIAS','RESCIS√ÉO','APOSENTADORIA','CONTROLE DE BENEF√çCIOS','SA√öDE E SEGURAN√áA','LTCAT','PCMSO','ASO','LAUDOS M√âDICOS','AGENDAMENTOS','ACIDENTES DE TRABALHO','PPRA','VISITAS T√âCNICAS','AVALIA√á√ïES DE DESEMPENHO','CONCEITOS','COMPET√äNCIAS','GEST√ÉO DE AVALIA√á√ïES DE DESEMPENHO','SOLICITA√á√ïES DE CURSOS','PLANEJAMENTO DE CURSOS','PRESTA√á√ÉO DE CONTAS']},{name:'Ponto (Cloud)',tasks:['CONFERIR PAR√ÇMETROS GERAIS E DO PONTO','CADASTRO DE REL√ìGIOS','JORNADAS DE TRABALHOS','CADASTRO DE HOR√ÅRIOS','CADASTRO DE ESCALAS','CADASTRO DE OCORR√äNCIAS','CADASTRO DE FUN√á√ïES DE REL√ìGIOS','CADASTRO DE PER√çODOS DE APURA√á√ÉO','CADASTRO DE FUN√á√ïES PARA F√ìRMULAS','CADASTRO DE TIPOS DE FUN√á√ïES DE REL√ìGIOS','CADASTRO DE LAN√áAMENTO DE HORAS','CADASTRO DE PERMUTAS']},{name:'eSocial',tasks:['CORRE√á√ïES DE BASE','ENVIOS','CONSULTAS E ACOMPANHAMENTOS','RELAT√ìRIOS','AUDITORIAS','PRESTA√á√ÉO DE CONTAS']}]
        };
        const titleCase = (str) => !str ? '' : str.toLowerCase().split(' ').map(w => ['e','de','da','do','dos','das','a','o','em','para','com'].includes(w) ? w : w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
        for (const v in data) { data[v].forEach(p => { p.tasks = p.tasks.map(t => titleCase(t)); }); }
        return data;
    }
};

// =================================================================
// ======================== APP DE STATUS ==========================
// =================================================================
const StatusApp = {
    allProjectsData: [],
    inclusaoData: [],
    inclusaoChartData: {},
    implantacaoListData: [],
    implantacaoChartData: {},
    groupedByCity: {},

    etapaWeights: {
        'planejamento e monitoramento': 2, 'kick-off': 1, 'kickoff': 1,
        'diagn√≥stico t√©cnico': 2, 'diagnostico': 2, 'migra√ß√£o de hml': 4,
        'configura√ß√£o de hml': 2, 'homologa√ß√£o de hml': 3, 'homologa√ß√£o e configrua√ß√£o da migra√ß√£o': 3,
        'migra√ß√£o de produ√ß√£o': 5, 'migra√ß√£o em produ√ß√£o': 5, 'treinamento': 3,
        'configura√ß√£o em produ√ß√£o': 2, 'configura√ß√£o de prd': 2, 'estabiliza√ß√£o': 3,
        'opera√ß√£o assistida': 2
    },

    findWeight: function(etapa) {
        const normalizedEtapa = etapa.toLowerCase().trim();
        for (const key in this.etapaWeights) {
            if (normalizedEtapa.includes(key)) {
                return this.etapaWeights[key];
            }
        }
        return 0; // Retorna 0 se n√£o encontrar peso correspondente
    },

    normalizeString: function(str) {
        if (!str) return '';
        return str.toString().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    },

    init: function() {
        this.setupImporter();
        this.setupThemeToggle();
        this.setupMobileSidebar();
    },

    reset: function() {
        document.getElementById('status_dashboard-container').classList.add('hidden');
        document.getElementById('status_import-screen').classList.remove('hidden');
        document.getElementById('status_loading-spinner').classList.add('hidden');
        document.getElementById('status_error-message').classList.add('hidden');
        const fileInput = document.getElementById('status_file-input');
        if (fileInput) fileInput.value = '';
    },

    setupImporter: function() {
        const dropZone = document.getElementById('status_drop-zone');
        const fileInput = document.getElementById('status_file-input');
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); if (e.dataTransfer.files.length) this.handleFile(e.dataTransfer.files[0]); });
        fileInput.addEventListener('change', (e) => { if (e.target.files.length) this.handleFile(e.target.files[0]); });
    },

    handleFile: function(file) {
        const loadingSpinner = document.getElementById('status_loading-spinner');
        const errorMessage = document.getElementById('status_error-message');
        loadingSpinner.classList.remove('hidden');
        errorMessage.classList.add('hidden');
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array', cellDates: true });
                this.processWorkbook(workbook);
                document.getElementById('status_import-screen').classList.add('hidden');
                document.getElementById('status_dashboard-container').classList.remove('hidden');
                this.initDashboard();
            } catch (error) {
                console.error("Erro ao processar arquivo (Status):", error);
                errorMessage.textContent = "Erro ao ler a planilha. Verifique o formato.";
                errorMessage.classList.remove('hidden');
            } finally {
                loadingSpinner.classList.add('hidden');
            }
        };
        reader.onerror = () => { errorMessage.textContent = "N√£o foi poss√≠vel ler o arquivo."; errorMessage.classList.remove('hidden'); loadingSpinner.classList.add('hidden'); };
        reader.readAsArrayBuffer(file);
    },

    processWorkbook: function(workbook) {
        this.allProjectsData = []; this.inclusaoData = []; this.inclusaoChartData = {};
        this.implantacaoListData = []; this.implantacaoChartData = {}; this.groupedByCity = {};
        workbook.SheetNames.forEach(sheetName => {
            const data = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { header: 1, defval: null });
            if (sheetName.toLowerCase().includes('inclus√£o')) { this.parseInclusaoSheet(data); } 
            else if (sheetName.toLowerCase().includes('implanta√ß√£o')) { this.parseImplantacaoSheet(data); } 
            else { const project = this.parseProjectSheet(sheetName, data); if (project) this.allProjectsData.push(project); }
        });
        this.groupProjectsByCity();
    },

    formatDate: function(date) {
        if (!date) return null;
        try {
            if (typeof date === 'string' && date.match(/^\d{4}-\d{2}-\d{2}$/)) return date;
            const jsDate = new Date(date);
            return new Date(jsDate.getTime() + (jsDate.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
        } catch(e) { return null; }
    },

    getProjectInfoFromSheet: function(sheetName) {
        const cityMap = {'Lagoa Santa':['lagoa santa','ls'],'Jaragu√° do Sul':['jaragu√° do sul','jargua do sul'],'S√£o Bento do Sul':['s√£o bento do sul','sao bento do sul'],'Major Gercino':['major gercino'],'Lages':['lages'],'Divin√≥polis':['divinopolis','divin√≥polis'],'Sang√£o':['sang√£o'],'Pedras Grandes':['pedras grandes'],'Armaz√©m':['armazem']};
        const lowerSheetName = sheetName.toLowerCase();
        for (const [cityName, aliases] of Object.entries(cityMap)) {
            for (const alias of aliases) {
                if (lowerSheetName.includes(alias)) {
                    let vertical = sheetName.replace(new RegExp(alias, 'i'), '').replace(/^\s*-\s*|\s*-\s*$/g, '').trim();
                    if (vertical.toLowerCase().startsWith('samae')) vertical = 'Protocolo Samae';
                    if (!vertical || vertical.toLowerCase() === cityName.toLowerCase()) return { city: cityName, name: cityName };
                    return { city: cityName, name: `${cityName} - ${vertical}` };
                }
            }
        }
        return { city: sheetName.split(' - ')[0].trim(), name: sheetName.trim() };
    },

    parseProjectSheet: function(sheetName, data) {
        const { city, name } = this.getProjectInfoFromSheet(sheetName);
        let project = { id: sheetName.toLowerCase().replace(/[^a-z0-9]+/g, '-'), name, city, cronograma: [], pontosAtencao: [], dados: {} };
        let parsingCronograma = false, parsingAtencaoDados = false;
        for (const row of data) {
            if (!row || row.filter(cell => cell !== null).length < 2) { parsingCronograma = false; parsingAtencaoDados = false; continue; }
            if (row[0] && typeof row[0] === 'string' && row[0].trim().toLowerCase().includes('etapa')) { parsingCronograma = true; parsingAtencaoDados = false; continue; }
            if (row[0] && typeof row[0] === 'string' && row[0].trim().toLowerCase().includes('pontos de aten√ß√£o')) { parsingCronograma = false; parsingAtencaoDados = true; continue; }
            if (parsingCronograma) {
                 const [etapa, inicio, fim, checklist] = row;
                 if (etapa) project.cronograma.push({ etapa: String(etapa).trim(), inicio: this.formatDate(inicio), fim: this.formatDate(fim), checklist: checklist ? String(checklist).trim() : 'A definir' });
            } else if (parsingAtencaoDados) {
                if (row[0]) project.pontosAtencao.push(String(row[0]).trim());
                if (row[2]) {
                    const key = String(row[2]).replace(':', '').trim().toLowerCase().replace(/\s+/g, '');
                    project.dados[key] = row[3] !== null ? row[3] : 'N/A';
                }
            }
        }
        return (project.cronograma.length > 0 || Object.keys(project.dados).length > 0) ? project : null;
    },

    parseFinancialSheet: function(data, list, chart) {
        let productHeaderRow = -1, chartHeaderRow = -1;
        data.forEach((row, index) => {
            if (row && String(row[0]).trim() === 'Produto' && String(row[1]).trim() === 'Data' && String(row[2]).trim() === 'Valor') productHeaderRow = index;
            if (row && String(row[5]).trim() === 'M√™s' && (String(row[6]).trim() === 'Valores' || String(row[6]).trim() === 'Valor')) chartHeaderRow = index;
        });
        if (productHeaderRow > -1) {
            for (let i = productHeaderRow + 1; i < data.length; i++) {
                if (!data[i] || !data[i][0]) break;
                list.push({ produto: data[i][0], data: this.formatDate(data[i][1]), valor: parseFloat(data[i][2]) || 0 });
            }
        }
        if (chartHeaderRow > -1) {
            chart.labels = []; chart.data = [];
            for (let i = chartHeaderRow + 1; i < data.length; i++) {
                if (!data[i] || !data[i][5] || data[i][6] === null || String(data[i][5]).trim() === '' || isNaN(parseFloat(data[i][6]))) break;
                chart.labels.push(String(data[i][5]).trim());
                chart.data.push(parseFloat(data[i][6]));
            }
        }
    },
    
    parseInclusaoSheet: function(data) { this.inclusaoData = []; this.inclusaoChartData = {}; this.parseFinancialSheet(data, this.inclusaoData, this.inclusaoChartData); },
    parseImplantacaoSheet: function(data) { this.implantacaoListData = []; this.implantacaoChartData = {}; this.parseFinancialSheet(data, this.implantacaoListData, this.implantacaoChartData); },

    groupProjectsByCity: function() {
        this.groupedByCity = this.allProjectsData.reduce((acc, p) => {
            if (!p.city) return acc;
            if (!acc[p.city]) acc[p.city] = { id: p.city.toLowerCase().replace(/\s+/g, '-').replace(/[^\w-]+/g, ''), name: p.city, projects: [] };
            acc[p.city].projects.push(p);
            return acc;
        }, {});
    },

    setupMobileSidebar: function() {
        const sidebar = document.getElementById('status_sidebar');
        const overlay = document.getElementById('status_sidebar-overlay');
        const toggle = () => { sidebar.classList.toggle('-translate-x-full'); overlay.classList.toggle('hidden'); };
        document.getElementById('status_hamburger-btn').addEventListener('click', toggle);
        overlay.addEventListener('click', toggle);
    },

    setupThemeToggle: function() {
        const themeToggle = document.getElementById('status_theme-toggle');
        const updateIcons = () => {
            const isDark = document.documentElement.classList.contains('dark');
            document.getElementById('status_theme-icon-light').classList.toggle('hidden', isDark);
            document.getElementById('status_theme-icon-dark').classList.toggle('hidden', !isDark);
        };
        themeToggle.addEventListener('click', () => { document.documentElement.classList.toggle('dark'); updateIcons(); });
        updateIcons();
    },

    renderSidebar: function() {
        const navMenu = document.getElementById('status_main-nav');
        navMenu.innerHTML = `<a href="#overview" class="sidebar-link flex items-center px-6 py-3 hover:bg-slate-700"><svg class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>Vis√£o Geral</a><a href="#timeline" class="sidebar-link flex items-center px-6 py-3 hover:bg-slate-700"><svg class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>Linha do Tempo</a><a href="#financeiro-inclusao" class="sidebar-link flex items-center px-6 py-3 hover:bg-slate-700"><svg class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z" /></svg>Financeiro - Inclus√£o</a><a href="#projecao-implantacao" class="sidebar-link flex items-center px-6 py-3 hover:bg-slate-700"><svg class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>Proje√ß√£o de Implanta√ß√£o</a><div class="px-6 mt-4 mb-2 text-xs uppercase text-slate-400">Cidades</div>`;
        Object.values(this.groupedByCity).sort((a,b) => a.name.localeCompare(b.name)).forEach(city => navMenu.innerHTML += `<a href="#${city.id}" class="sidebar-link flex items-center px-6 py-3 hover:bg-slate-700"><svg class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>${city.name}</a>`);
    },

    renderPages: function() {
        const pageContainer = document.getElementById('status_page-container');
        pageContainer.innerHTML = '';
        const createPage = id => { const page = document.createElement('div'); page.id = id; page.className = 'page'; pageContainer.appendChild(page); return page; };
        this.renderOverviewContent(createPage('overview'));
        this.renderTimelinePage(createPage('timeline'));
        this.renderFinancialPage(createPage('financeiro-inclusao'), 'Financeiro - Inclus√£o', this.inclusaoData, 'status_financialChartInclusao', this.inclusaoChartData);
        this.renderFinancialPage(createPage('projecao-implantacao'), 'Proje√ß√£o de implanta√ß√£o', this.implantacaoListData, 'status_financialChartImplantacao', this.implantacaoChartData);
        Object.values(this.groupedByCity).sort((a,b) => a.name.localeCompare(b.name)).forEach(city => this.renderCityPage(createPage(city.id), city));
    },

    renderCityPage: function(container, cityData) {
        const getShortName = (name, city) => name === city ? city : name.replace(city, '').replace(' - ', '').trim();
        const tabs = cityData.projects.map((p, i) => `<li><button class="tab-link font-semibold p-4 border-b-2 rounded-t-lg ${i === 0 ? 'active' : ''}" data-target="${p.id}-content" data-full-name="${p.name}">${getShortName(p.name, cityData.name)}</button></li>`).join('');
        const contents = cityData.projects.map((p, i) => `<div id="${p.id}-content" class="tab-content ${i === 0 ? 'active' : ''}"></div>`).join('');
        container.innerHTML = `<h1 id="${cityData.id}-title" class="text-3xl md:text-4xl font-bold text-main mb-4">${cityData.projects[0].name}</h1><div class="mb-4 border-b border-color"><ul class="flex flex-wrap -mb-px text-sm font-medium text-center" id="${cityData.id}-tabs">${tabs}</ul></div><div id="${cityData.id}-tab-content">${contents}</div>`;
        cityData.projects.forEach(p => this.renderProjectContent(container.querySelector(`#${p.id}-content`), p));
        const tabsEl = container.querySelector(`#${cityData.id}-tabs`), titleEl = container.querySelector(`#${cityData.id}-title`);
        tabsEl.addEventListener('click', (e) => {
            if (e.target.matches('.tab-link')) {
                e.preventDefault();
                tabsEl.querySelectorAll('.tab-link').forEach(t => t.classList.remove('active'));
                container.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                e.target.classList.add('active');
                container.querySelector(`#${e.target.dataset.target}`).classList.add('active');
                titleEl.textContent = e.target.dataset.fullName;
            }
        });
    },

    renderOverviewContent: function(container) {
        const cityCardsHtml = Object.values(this.groupedByCity).sort((a,b) => a.name.localeCompare(b.name)).map(city => {
            const num = (p, k) => (p.dados[k] || 0), currency = v => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v);
            const totalRecursos = city.projects.reduce((s, p) => s + (parseInt(p.dados.recursos, 10) || 0), 0);
            const totalImplantacao = city.projects.reduce((s, p) => s + (parseFloat(p.dados.implanta√ß√£o || p.dados.implantacao || p.dados.educa√ß√£o) || 0), 0);
            const totalRecorrente = city.projects.reduce((s, p) => s + (parseFloat(p.dados.recorrente) || 0), 0);
            const links = city.projects.map(p => `<li><a href="#${city.id}" data-project-target="${p.id}-content" class="project-link block px-4 py-3 text-slate-700 dark:text-slate-200 hover:bg-sky-500 dark:hover:bg-sky-600 hover:text-white text-sm font-medium">${p.name.replace(city.name,'').replace(' - ','').trim()||city.name}</a></li>`).join('');
            return `<div class="relative group p-4 card-bg rounded-lg shadow-sm border border-color city-card hover:shadow-lg hover:border-sky-500 cursor-pointer" data-href="#${city.id}"><span class="font-semibold text-main text-lg">${city.name}</span><div class="mt-2 text-xs text-secondary space-y-1"><div><strong>Projetos:</strong> ${city.projects.length}</div><div><strong>Recursos:</strong> ${totalRecursos || 'A definir'}</div><div><strong>Implanta√ß√£o:</strong> ${currency(totalImplantacao)}</div><div><strong>Recorrente:</strong> ${totalRecorrente?currency(totalRecorrente):'N/A'}</div></div><div class="city-card-projects absolute z-20 top-full left-0 min-w-full bg-slate-50 dark:bg-slate-900 border dark:border-slate-700 rounded-lg shadow-2xl overflow-hidden"><ul class="divide-y divide-slate-200 dark:divide-slate-700">${links}</ul></div></div>`;
        }).join('');
        const projectsByStatus = this.allProjectsData.reduce((acc, p) => { const s = this.getProjectStatus(p).text.toLowerCase().replace(/\s/g, ''); acc[s] = (acc[s] || []); acc[s].push(p); return acc; }, {});
        const createTooltip = (projects) => {
            if (projects.length === 0) return '';
            const links = projects.map(p => {
                const cityId = p.city.toLowerCase().replace(/\s+/g, '-').replace(/[^\w-]+/g, '');
                return `<li><a href="#${cityId}" data-project-target="${p.id}-content" class="status-tooltip-link project-link block px-4 py-3 hover:bg-sky-100 dark:hover:bg-sky-600 text-sm font-medium">${p.name}</a></li>`
            }).join('');
            return `<div class="absolute z-20 top-full left-1/2 -translate-x-1/2 pt-2 w-72 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-opacity"><div class="status-tooltip border rounded-lg shadow-2xl overflow-hidden"><ul class="divide-y divide-slate-200 dark:divide-slate-700 max-h-60 overflow-y-auto">${links}</ul></div></div>`;
        };
        const statusCard = (t, c, p) => `<div class="relative group"><div class="card-bg p-4 rounded-lg shadow-sm text-center h-full"><h3 class="text-secondary font-semibold text-sm">${t}</h3><p class="text-3xl font-bold ${c} mt-1">${p.length}</p></div>${createTooltip(p)}</div>`;
        container.innerHTML = `<h1 class="text-3xl md:text-4xl font-bold text-main mb-2">Portf√≥lio Clientes Premium SC/MG</h1><div class="flex flex-col md:flex-row flex-wrap gap-x-8 gap-y-2 text-secondary mb-6 text-sm"><span><strong>Gerente:</strong> Leandro de Faveri</span><span><strong>Coordenador:</strong> Maxwell Santos</span><span><strong>Gerentes de Projetos:</strong> Vitor Vargas, Marcos Bergamaschi</span></div><div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6"><div class="card-bg p-4 rounded-lg shadow-sm text-center"><h3 class="text-secondary font-semibold text-sm">Total</h3><p class="text-3xl font-bold text-main mt-1">${this.allProjectsData.length}</p></div>${statusCard('N√£o Iniciado','text-gray-400',projectsByStatus.n√£oiniciado||[])}${statusCard('Em Dia','text-green-500',projectsByStatus.emdia||[])}${statusCard('Aten√ß√£o','text-yellow-500',projectsByStatus.aten√ß√£o||[])}${statusCard('Atrasado','text-red-500',projectsByStatus.atrasado||[])}${statusCard('Conclu√≠do','text-emerald-500',projectsByStatus.conclu√≠do||[])}</div><div class="card-bg p-4 rounded-lg shadow-sm"><h2 class="text-xl font-bold mb-4 text-center text-main">Lista de Cidades</h2><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">${cityCardsHtml}</div></div>`;
    },

    renderTimelinePage: function(container) { container.innerHTML = `<h1 class="text-3xl md:text-4xl font-bold text-main mb-4">Linha do Tempo de Entregas</h1><div class="card-bg p-4 rounded-lg shadow-sm">${this.renderOverviewTimelineGrid()}</div>`; },
    
    renderFinancialPage: function(container, title, listData, chartId, chartDataSource) {
        const sortedList = listData.slice().sort((a, b) => luxon.DateTime.fromISO(a.data) - luxon.DateTime.fromISO(b.data));
        const listHtml = sortedList.map(item => `<li class="flex flex-col sm:flex-row justify-between items-start sm:items-center p-3 hover:bg-slate-800/50 rounded-md"><span class="text-secondary mb-1 sm:mb-0">${item.produto}</span><div class="flex items-center space-x-4 w-full sm:w-auto justify-between"><span class="font-mono text-sm text-secondary">${item.data ? luxon.DateTime.fromISO(item.data).toFormat('dd/MM/yyyy') : 'N/A'}</span><span class="font-semibold text-main w-32 text-right">${new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(item.valor)}</span></div></li>`).join('');
        const total = (chartDataSource?.data?.length > 0) ? chartDataSource.data.reduce((s, v) => s + v, 0) : listData.reduce((s, i) => s + (i.valor || 0), 0);
        container.innerHTML = `<h1 class="text-3xl md:text-4xl font-bold text-main mb-2">${title}</h1><p class="text-lg font-semibold text-sky-400 mb-6">Valor Total: ${new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(total)}</p><div class="grid grid-cols-1 gap-6"><div class="card-bg p-4 rounded-lg shadow-sm"><h2 class="text-xl font-bold mb-4 text-center text-main">Valor por M√™s</h2><div class="h-96"><canvas id="${chartId}"></canvas></div></div><div class="card-bg p-4 rounded-lg shadow-sm"><h2 class="text-xl font-bold mb-4 text-center text-main">Lista de Produtos</h2><div id="${chartId}-list" class="max-h-96 overflow-y-auto"><ul class="divide-y border-color">${listHtml}</ul></div></div></div>`;
        const monthlyTotals = listData.reduce((acc, item) => { if(item.data){ const month = luxon.DateTime.fromISO(item.data).toFormat('MMM/yy'); acc[month] = (acc[month] || 0) + item.valor; } return acc; }, {});
        const sortedMonths = Object.keys(monthlyTotals).sort((a,b) => luxon.DateTime.fromFormat(a, 'MMM/yy') - luxon.DateTime.fromFormat(b, 'MMM/yy'));
        const dynamicChartData = { labels: sortedMonths, data: sortedMonths.map(m => monthlyTotals[m]) };
        this.renderFinancialChart(chartId, dynamicChartData, listData, `${chartId}-list`);
    },

    renderProjectContent: function(container, project) {
        const attention = project.pontosAtencao.map(p => `<li class="p-2 font-bold text-main">${p}</li>`).join('') || '<li>Nenhum ponto de aten√ß√£o.</li>';
        const validEntries = project.cronograma.filter(i => i.inicio && i.fim), f = 'dd/MM/yyyy';
        let start = 'N/A', end = 'N/A', pct = 0;
        if (validEntries.length > 0) {
            start = luxon.DateTime.min(...validEntries.map(e => luxon.DateTime.fromISO(e.inicio))).toFormat(f);
            end = luxon.DateTime.max(...validEntries.map(e => luxon.DateTime.fromISO(e.fim))).toFormat(f);
            
            let totalPossibleWeight = 0;
            let achievedWeight = 0;

            project.cronograma.forEach(item => {
                const weight = this.findWeight(item.etapa);
                if (weight > 0 && item.checklist?.toLowerCase() !== 'n√£o se aplica') {
                    totalPossibleWeight += weight;
                    if (item.checklist?.toLowerCase().includes('concluido')) {
                        achievedWeight += weight;
                    }
                }
            });

            pct = totalPossibleWeight > 0 ? Math.round((achievedWeight / totalPossibleWeight) * 100) : 0;
        }
        const currency = v => typeof v === 'number' ? new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v) : v || 'N/A';
        const impl = currency(project.dados.implantacao || project.dados.implanta√ß√£o || project.dados.educa√ß√£o), rec = currency(project.dados.recorrente);
        container.innerHTML = `<div class="flex flex-col sm:flex-row flex-wrap gap-x-8 gap-y-2 text-secondary mb-4 text-sm"><span><strong>Gerente:</strong> ${project.dados.gerentedeprojeto||'N/A'}</span><span><strong>Implantador:</strong> ${project.dados.implantador||'N/A'}</span><span><strong>Cliente:</strong> ${project.dados.cliente||'N/A'}</span></div><div class="flex flex-col sm:flex-row flex-wrap gap-x-8 gap-y-2 text-secondary mb-4 border-t border-b border-color py-3"><span><strong>Implanta√ß√£o:</strong> ${impl}</span><span><strong>Recorrente:</strong> ${rec}</span></div><div class="grid grid-cols-1 lg:grid-cols-3 gap-6"><div class="lg:col-span-2 card-bg p-4 rounded-lg shadow-sm"><h2 class="text-xl font-bold mb-4 text-main">Cronograma</h2><div class="flex flex-col sm:flex-row flex-wrap justify-between items-center mb-4 text-secondary border-b border-t border-color py-3 gap-y-4"><div class="text-sm"><strong>In√≠cio:</strong> ${start}</div><div class="text-sm"><strong>Fim:</strong> ${end}</div><div class="text-sm w-full sm:w-auto"><strong>Conclus√£o:</strong><div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700 mt-1"><div class="bg-blue-600 h-2.5 rounded-full" style="width: ${pct}%"></div></div><span class="font-bold">${pct}%</span></div></div><div class="flex flex-wrap gap-x-4 gap-y-2 mb-4 text-sm text-secondary"><div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-emerald-500"></div>Conclu√≠do</div><div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-sky-500"></div>Em Andamento</div><div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-red-500"></div>Atrasado</div><div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-slate-400"></div>N√£o Iniciado</div></div><div class="space-y-3">${this.renderGanttChart(project.cronograma)}</div></div><div class="lg:col-span-1 card-bg p-4 rounded-lg shadow-sm"><h2 class="text-xl font-bold mb-4 text-main">Pontos de Aten√ß√£o</h2><ul class="space-y-3">${attention}</ul></div></div>`;
    },

    getProjectStatus: function(project) {
        if (!project.cronograma?.length) return { text: 'Sem Dados', color: 'bg-slate-400' };
        if (project.cronograma.every(i => (i.checklist?.toLowerCase().includes('n√£o iniciado') || !i.inicio))) return { text: 'N√£o Iniciado', color: 'bg-gray-400' };
        const validEntries = project.cronograma.filter(i => i.fim && luxon.DateTime.fromISO(i.fim).isValid);
        if(!validEntries.length) return { text: 'N√£o Iniciado', color: 'bg-gray-400' };
        const lastDate = luxon.DateTime.max(...validEntries.map(i => luxon.DateTime.fromISO(i.fim)));
        if (project.cronograma.filter(i => i.checklist?.toLowerCase() !== 'n√£o se aplica').every(i => i.checklist?.toLowerCase().includes('concluido'))) return { text: 'Conclu√≠do', color: 'bg-emerald-500' };
        const now = luxon.DateTime.now();
        if (lastDate < now.startOf('day')) return { text: 'Atrasado', color: 'bg-red-500' };
        if (lastDate.diff(now.startOf('day'), 'days').days <= 7) return { text: 'Aten√ß√£o', color: 'bg-yellow-500' };
        return { text: 'Em Dia', color: 'bg-green-500' };
    },
    
    renderOverviewTimelineGrid: function() {
        const normalize = this.normalizeString;
        const projects = this.allProjectsData.map(p => {
            const findStep = (keywords) => p.cronograma.find(i => {
                if (!i.fim) return false;
                const normalizedEtapa = normalize(i.etapa);
                return keywords.some(kw => normalizedEtapa.includes(normalize(kw)));
            });
            
            const releaseEvent = findStep(['produ√ß√£o', 'virada', 'prd']);
            const endEvent = findStep(['opera√ß√£o assistida']);
            const lastEntry = [...p.cronograma].filter(i => i.fim).sort((a,b) => luxon.DateTime.fromISO(b.fim) - luxon.DateTime.fromISO(a.fim))[0];

            return {
                name: p.name,
                endDate: (endEvent?.fim) ? luxon.DateTime.fromISO(endEvent.fim) : (lastEntry ? luxon.DateTime.fromISO(lastEntry.fim) : null),
                releaseDate: releaseEvent?.fim ? luxon.DateTime.fromISO(releaseEvent.fim) : null
            }
        }).filter(p => p.endDate && p.endDate.isValid).sort((a, b) => a.endDate - b.endDate);

        if (projects.length === 0) return '<p class="text-center text-secondary">N√£o h√° datas para exibir.</p>';

        const minDate = projects[0].endDate.startOf('month');
        const maxDate = luxon.DateTime.max(...projects.map(p => p.endDate)).endOf('month').plus({months: 1});
        const totalDays = maxDate.diff(minDate, 'days').days;

        let dateMarkers = '';
        let cMonth = minDate;
        while(cMonth < maxDate) {
            const daysFromStart = cMonth.diff(minDate, 'days').days;
            const leftPercent = (daysFromStart / totalDays) * 100;
            dateMarkers += `<div class="absolute text-center" style="left: ${leftPercent}%;"><div class="h-full w-px border-color"></div><span class="text-xs text-secondary absolute top-full mt-1" style="transform: translateX(-50%);">${cMonth.toFormat('dd')}</span></div>`;
            cMonth = cMonth.plus({days: 15});
        }
        
        const monthMarkers = () => {
            let markers = ''; let m = minDate;
            while(m < maxDate) {
                const widthPercent = (m.daysInMonth / totalDays) * 100;
                markers += `<div style="width: ${widthPercent}%" class="text-center text-sm font-semibold text-secondary border-b-2 border-color pb-1">${m.toFormat('MMM/yy')}</div>`;
                m = m.plus({months: 1});
            } return markers;
        }
        
        const projectRows = projects.map(p => {
            const endLeft = (p.endDate.diff(minDate, 'days').days / totalDays) * 100;
            let triangle = '';
            if (p.releaseDate?.isValid) {
                const releaseLeft = (p.releaseDate.diff(minDate, 'days').days / totalDays) * 100;
                triangle = `<div class="absolute timeline-marker" style="left: ${releaseLeft}%; top: 50%; transform: translate(-50%, -50%); z-index: 6;">
                    <span style="position: absolute; right: 100%; margin-right: 8px; top: 50%; transform: translateY(-50%);" class="text-xs font-semibold text-secondary whitespace-nowrap">${p.releaseDate.toFormat('dd/MM')}</span>
                    <div class="triangle cursor-pointer" style="border-bottom: 14px solid #0ea5e9;"></div>
                    <div class="tooltip absolute bottom-full mb-2 w-max p-2 bg-slate-800 text-white text-xs rounded-md shadow-lg" style="left: 50%; transform: translateX(-50%);"><strong>${p.name}</strong><br>Libera√ß√£o: ${p.releaseDate.toFormat('dd/MM/yyyy')}</div>
                </div>`;
            }
            const dot = `<div class="absolute timeline-marker flex items-center" style="left: ${endLeft}%; top: 50%; transform: translate(-50%, -50%); z-index: 5;"><div class="w-4 h-4 bg-green-500 rounded-full cursor-pointer border-2 border-white shadow-lg"></div><span class="ml-2 text-xs font-semibold text-secondary whitespace-nowrap">${p.endDate.toFormat('dd/MM')}</span><div class="tooltip absolute bottom-full mb-2 w-max p-2 bg-slate-800 text-white text-xs rounded-md shadow-lg" style="left: 50%; transform: translateX(-50%);"><strong>${p.name}</strong><br>Fim: ${p.endDate.toFormat('dd/MM/yyyy')}</div></div>`;
            return `<div class="flex items-center border-t border-color h-16"><div class="w-48 pr-4 text-sm font-semibold text-secondary text-right flex-shrink-0">${p.name}</div><div class="relative flex-grow h-full">${triangle}${dot}</div></div>`;
        }).join('');

        const legend = `<div class="mb-6 flex items-center justify-center gap-6 text-sm text-secondary"><div class="flex items-center gap-2"><div class="triangle" style="border-bottom: 14px solid #0ea5e9;"></div>Libera√ß√£o Cliente</div><div class="flex items-center gap-2"><div class="w-3 h-3 bg-green-500 rounded-full"></div>Fim do Projeto</div></div>`;
        return `${legend}<div class="overflow-x-auto"><div class="min-w-[1200px]"><div class="flex"><div class="w-48 flex-shrink-0 pr-4"></div><div class="flex-grow flex">${monthMarkers()}</div></div><div class="flex"><div class="w-48 flex-shrink-0 pr-4"></div><div class="relative flex-grow h-6">${dateMarkers}</div></div><div class="flex flex-col">${projectRows}</div></div></div>`;
    },
    
    renderGanttChart: function(cronograma) {
        return cronograma.map(item => {
            if (!item.inicio || !item.fim) return `<div class="mb-2"><div class="flex justify-between items-center mb-1"><p class="text-sm font-medium text-main">${item.etapa}</p><p class="text-xs font-mono text-white font-bold">${item.checklist}</p></div><div class="w-full h-6 gantt-bar-bg rounded"></div></div>`;
            const start = luxon.DateTime.fromISO(item.inicio), end = luxon.DateTime.fromISO(item.fim), now = luxon.DateTime.now(), status = item.checklist?.toLowerCase()||'';
            let progress = 0, color = 'bg-slate-400';
            if (status.includes('concluido')) { progress = 100; color = 'bg-emerald-500'; } 
            else if (status.includes('andamento')) {
                const total = end.diff(start, 'days').days;
                progress = total > 0 ? Math.min(100, (now.diff(start, 'days').days / total) * 100) : (now >= start ? 100: 0);
                color = now > end ? 'bg-red-500' : 'bg-sky-500';
            } else { if (now > end) color = 'bg-red-500'; }
            return `<div class="mb-2"><div class="flex justify-between items-center mb-1"><p class="text-sm font-medium text-main">${item.etapa}</p><p class="text-xs font-mono text-white font-bold">${start.toFormat('dd/MM/yy')} - ${end.toFormat('dd/MM/yy')}</p></div><div class="w-full h-6 gantt-bar-bg rounded"><div class="gantt-bar ${color}" style="width: ${progress}%;"></div></div></div>`;
        }).join('');
    },
    
    renderFinancialChart: function(chartId, chartDataSource, fullListData, listContainerId) {
        const ctx = document.getElementById(chartId);
        if (!ctx) return;
        if (Chart.getChart(chartId)) Chart.getChart(chartId).destroy();
        new Chart(ctx, { type: 'bar', data: { labels: chartDataSource.labels, datasets: [{ label: 'Faturamento (R$)', data: chartDataSource.data, backgroundColor: 'rgba(56, 189, 248, 0.6)', borderColor: 'rgba(56, 189, 248, 1)', borderWidth: 1, borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, onClick: (e, els) => { if (els.length > 0) this.filterFinancialListByMonth(chartDataSource.labels[els[0].index], fullListData, listContainerId); }, scales: { y: { beginAtZero: true, ticks: { color: '#94a3b8', callback: v => 'R$ ' + v.toLocaleString('pt-BR') }, grid: { color: '#334155' } }, x: { ticks: { color: '#94a3b8' }, grid: { color: '#334155' } } }, plugins: { legend: { display: false }, tooltip: { callbacks: { label: c => `R$ ${c.parsed.y.toLocaleString('pt-BR')}` } } } } });
    },

    filterFinancialListByMonth: function(selectedMonth, fullListData, listContainerId) {
        const container = document.getElementById(listContainerId);
        if (!container) return;
        const isShortFormat = /\w{3}\/\d{2}/.test(selectedMonth);
        const filtered = fullListData.filter(item => {
            if (!item.data) return false;
            const itemDate = luxon.DateTime.fromISO(item.data).setLocale('pt-BR');
            if (isShortFormat) {
                return itemDate.toFormat('MMM/yy') === selectedMonth;
            } else {
                return itemDate.toFormat('MMMM').toLowerCase() === selectedMonth.toLowerCase();
            }
        });

        const listHtml = filtered.sort((a,b)=>luxon.DateTime.fromISO(a.data)-luxon.DateTime.fromISO(b.data)).map(i=>`<li class="flex flex-col sm:flex-row justify-between p-3 hover:bg-slate-800/50 rounded-md"><span class="text-secondary">${i.produto}</span><div class="flex items-center space-x-4"><span class="font-mono text-sm text-secondary">${i.data?luxon.DateTime.fromISO(i.data).toFormat('dd/MM/yyyy'):'N/A'}</span><span class="font-semibold text-main w-32 text-right">${new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(i.valor)}</span></div></li>`).join('');
        container.innerHTML = `<ul class="divide-y border-color">${listHtml||'<li class="p-3 text-center text-secondary">Nenhum projeto encontrado para este m√™s.</li>'}</ul><button id="${listContainerId}-reset" class="text-sky-500 font-semibold text-sm mt-2 p-2 w-full hover:bg-slate-800/50 rounded-md">Mostrar Todos</button>`;
        document.getElementById(`${listContainerId}-reset`).addEventListener('click', () => {
            const originalHtml = fullListData.sort((a,b)=>luxon.DateTime.fromISO(a.data)-luxon.DateTime.fromISO(b.data)).map(i=>`<li class="flex flex-col sm:flex-row justify-between p-3 hover:bg-slate-800/50 rounded-md"><span class="text-secondary">${i.produto}</span><div class="flex items-center space-x-4"><span class="font-mono text-sm text-secondary">${i.data?luxon.DateTime.fromISO(i.data).toFormat('dd/MM/yyyy'):'N/A'}</span><span class="font-semibold text-main w-32 text-right">${new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(i.valor)}</span></div></li>`).join('');
            container.innerHTML = `<ul class="divide-y border-color">${originalHtml}</ul>`;
        });
    },

    setupNavigation: function() {
        const showPage = (pageId, projectTargetId = null) => {
            document.querySelectorAll('#status-app-container .page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('#status-app-container .sidebar-link').forEach(l => l.classList.remove('active'));
            const page = document.getElementById(pageId); if(page) page.classList.add('active');
            const link = document.querySelector(`#status_main-nav a[href="#${pageId}"]`); if(link) link.classList.add('active');
            document.getElementById('status_theme-toggle-container').style.display = (pageId === 'overview') ? 'flex' : 'none';
            if (pageId === 'financeiro-inclusao') this.renderFinancialChart('status_financialChartInclusao', this.inclusaoChartData, this.inclusaoData, 'status_financialChartInclusao-list');
            else if (pageId === 'projecao-implantacao') this.renderFinancialChart('status_financialChartImplantacao', this.implantacaoChartData, this.implantacaoListData, 'status_financialChartImplantacao-list');
            if (projectTargetId) setTimeout(() => document.querySelector(`[data-target="${projectTargetId}"]`)?.click(), 50);
        };
        const handleNav = (e) => {
            const link = e.target.closest('a[href^="#"], .city-card[data-href]');
            if (link) {
                e.preventDefault();
                const pageId = (link.dataset.href || link.getAttribute('href')).substring(1);
                const projectTarget = link.dataset.projectTarget;
                if (window.location.hash !== `#${pageId}`) history.pushState({ pageId, projectTarget }, '', `#${pageId}`);
                showPage(pageId, projectTarget);
                if (window.innerWidth < 1024) document.getElementById('status_hamburger-btn').click();
            }
        };
        document.getElementById('status-app-container').addEventListener('click', handleNav);
        window.addEventListener('popstate', (e) => showPage(e.state?.pageId || 'overview', e.state?.projectTarget));
        showPage(window.location.hash.replace('#', '') || 'overview');
    },

    initDashboard: function() {
        this.renderSidebar();
        this.renderPages();
        this.setupNavigation();
    }
};

</script>
</body>
</html>



